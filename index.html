<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Peta Bencana</title>
    <link rel="icon" href="https://bidangrrjember.github.io/peta-bencana-jember/logo-bpbd.png" type="image/png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; overflow: hidden; background-color: #f0f2f5; }
        #header { position: absolute; top: 0; left: 0; right: 0; height: 50px; background-color: #ffffff; z-index: 1001; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; gap: 20px; }
        .header-title { display: flex; align-items: center; white-space: nowrap; }
        .header-title img { height: 30px; margin-right: 15px; }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        #map { position: absolute; top: 50px; left: 0; right: 0; bottom: 0; }
        #sidebar { position: absolute; left: -430px; top: 65px; bottom: 15px; width: 400px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-radius: 8px; transition: left 0.5s ease; z-index: 2000; display: flex; flex-direction: column; }
        #sidebar.visible { left: 15px; }
        #sidebar-header { padding: 0 20px; height: 50px; line-height: 50px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        #sidebar-header h3 { margin: 0; font-size: 1.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #sidebar-content { padding: 20px; overflow-y: auto; flex: 1; scrollbar-width: none; }
        #sidebar-content::-webkit-scrollbar { width: 0px; }
        #sidebar-footer { padding: 15px; text-align: center; border-top: 1px solid #e0e0e0; flex-shrink: 0; display: flex; justify-content: center; gap: 15px; }
        #summary-box { position: absolute; top: 65px; right: 15px; width: 220px; background: white; padding: 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 999; display: flex; flex-direction: column; }
        #summary-box h4 { margin: 0; text-align: center; border-bottom: 1px solid #eee; font-size: 1em; height: 49px; display: flex; align-items: center; justify-content: center; font-weight: 500; }
        #summary-content-wrapper { padding: 15px; }
        #loader { position: absolute; top: 50%; left: 50%; border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; z-index: 2000; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #search-box { position: absolute; left: 50%; transform: translateX(-50%); width: 400px; max-width: 40%; }
        #search-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        #dashboard-modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 1400px; border-radius: 8px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; }
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .chart-container { padding: 20px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); max-height: 450px; }
        .chart-container h5 { margin-top: 0; text-align: center; }
        #bantuan-table-container { grid-column: 1 / -1; }
        .bantuan-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .bantuan-table th, .bantuan-table td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 0.9em; }
        .bantuan-table th { background-color: #f2f2f2; font-weight: 500; }
        .stat-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; }
        .leaflet-bottom.leaflet-right { display: flex; flex-direction: column-reverse; align-items: flex-end; }
        #hamburger-btn { display: none; font-size: 28px; cursor: pointer; background: none; border: none; }
        #mobile-menu { display: none; position: fixed; top: 50px; left: 0; right: 0; bottom: 0; background-color: #f0f2f5; z-index: 4000; padding: 20px; overflow-y: auto; }
        .mobile-menu-item { margin-bottom: 20px; }
        .mobile-menu-item h4 { margin-top: 0; }
        .mobile-menu-item input { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .mobile-menu-item button { width: 100%; padding: 12px; font-size: 1em; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        #notification { position: absolute; top: 65px; left: 50%; transform: translateX(-50%); background-color: #28a745; color: white; padding: 10px 20px; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.25); z-index: 2001; cursor: default; display: none; transition: top 0.5s ease; }

        /* --- PERUBAHAN STYLE UNTUK HOVER DAN TOMBOL --- */
        .close-btn, .modal-close-btn {
            padding: 2px 10px; background-color: #adb5bd; color: white; border: none;
            border-radius: 5px; font-size: 1.5em; line-height: 1.2; cursor: pointer;
            text-decoration: none; transition: background-color 0.2s ease; user-select: none;
        }
        .close-btn:hover, .modal-close-btn:hover { background-color: #6c757d; }
        .sidebar-gallery { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .photo-link { 
            display: inline-block; padding: 8px 12px; 
            background-color: #e9ecef; border-radius: 5px; 
            text-decoration: none; color: #333; font-size: 0.9em;
            transition: background-color 0.2s ease;
        }
        .photo-link:hover { background-color: #dee2e6; }
        .route-button { 
            display: inline-block; padding: 10px 20px; 
            background-color: #1a73e8; color: white; border: none; 
            border-radius: 5px; font-size: 0.9em; font-weight: 500; 
            cursor: pointer; text-decoration: none;
            transition: background-color 0.2s ease;
        }
        .route-button:hover { background-color: #1765cc; }
        .download-button { 
            display: inline-block; padding: 10px 20px; 
            background-color: #28a745;
            color: white; border: none; 
            border-radius: 5px; font-size: 0.9em; font-weight: 500; 
            cursor: pointer; text-decoration: none;
            transition: background-color 0.2s ease;
        }
        .download-button:hover { background-color: #218838; }
        .jitupasna-btn { 
            background-color: #17a2b8; width: 50px; height: 50px; 
            border-radius: 50%; margin-bottom: 10px; display: flex; 
            align-items: center; justify-content: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .jitupasna-btn:hover { background-color: #138496; }
        .jitupasna-btn svg { width: 24px; height: 24px; fill: white; }
        #dashboard-btn { 
            background-color: #007bff; color: white; border: none; 
            padding: 8px 16px; border-radius: 5px; cursor: pointer; 
            font-weight: 500; white-space: nowrap;
            transition: background-color 0.2s ease;
        }
        #dashboard-btn:hover { background-color: #0056b3; }
        #fullscreen-btn { background: none; border: none; cursor: pointer; padding: 0; opacity: 0.7; transition: opacity 0.2s ease; }
        #fullscreen-btn:hover { opacity: 1; }
        #fullscreen-btn svg { width: 24px; height: 24px; fill: #6c757d; }

        /* --- PENAMBAHAN: Animasi untuk Marker Baru --- */
        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 0 0 rgba(23, 162, 184, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(23, 162, 184, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(23, 162, 184, 0);
            }
        }
        .marker-new {
            animation: pulse-glow 2s infinite;
            border-radius: 50%;
        }

        @media (max-width: 768px) {
            #summary-box, .header-actions, #search-box, .header-title span { display: none; }
            #hamburger-btn { display: block; }
            #sidebar { width: 100%; top: 50px; left: -100%; bottom: 0; border-radius: 0; }
            .modal-content { width: 95%; margin: 10% auto; }
            .chart-grid { grid-template-columns: 1fr; }
            #bantuan-table-container { overflow-x: auto; }
        }
    </style>
</head>
<body>
    <div id="header">
        <div class="header-title">
            <img src="https://bidangrrjember.github.io/peta-bencana-jember/logo-bpbd.png" alt="Logo">
            <span>Dashboard Pemetaan Bencana - BPBD Kabupaten Jember</span>
        </div>
        <div id="search-box">
            <input type="text" id="search-input" placeholder="Cari nama korban, dusun, atau kecamatan...">
        </div>
        <div class="header-actions">
             <button id="dashboard-btn">📊 Tampilkan Analisis</button>
             <button id="fullscreen-btn" title="Mode Layar Penuh">
                 <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
            </button>
        </div>
        <button id="hamburger-btn">☰</button>
    </div>
    <div id="mobile-menu">
        <div class="mobile-menu-item"><input type="text" id="mobile-search-input" placeholder="Cari nama korban..."></div>
        <div class="mobile-menu-item"><button id="mobile-dashboard-btn" class="route-button">📊 Tampilkan Analisis</button></div>
        <div class="mobile-menu-item" id="mobile-summary-box"><h4>Ringkasan Bencana</h4><div id="mobile-summary-content"></div><hr><div class="stat-item total-stat"><span>TOTAL BENCANA:</span> <span id="mobile-stat-total">0</span></div></div>
    </div>
    <div id="loader"></div><div id="map"></div>
    <div id="sidebar">
        <div id="sidebar-header"><h3 id="sidebar-title">Detail Laporan</h3><span class="close-btn" onclick="closeSidebar()">×</span></div>
        <div id="sidebar-content"></div>
        <div id="sidebar-footer">
            <a href="#" id="download-laporan-btn" target="_blank" class="download-button">Laporan JITUPASNA</a>
            <a href="#" id="route-button-link" target="_blank" class="route-button">Buka Rute</a>
        </div>
    </div>
    <div id="summary-box">
        <h4>Ringkasan Bencana</h4>
        <div id="summary-content-wrapper">
             <div id="summary-content"></div>
             <hr>
             <div class="stat-item total-stat"><span>TOTAL BENCANA:</span> <span id="stat-total">0</span></div>
        </div>
    </div>
    <div id="notification"></div>
    <div id="dashboard-modal"><div class="modal-content"><div class="modal-header"><h2>Analisis Data Bencana</h2><span class="modal-close-btn">×</span></div><div class="chart-grid"><div class="chart-container"><h5>Total Bencana per Kecamatan</h5><canvas id="chartKecamatan"></canvas></div><div class="chart-container"><h5>Total Bencana per Tingkat Kerusakan</h5><canvas id="chartKerusakan"></canvas></div><div class="chart-container"><h5>Kerusakan per Jenis Konstruksi</h5><canvas id="chartKonstruksi"></canvas></div><div class="chart-container" id="bantuan-table-container"><h5>Total Bantuan Stimulan Diberikan</h5></div></div></div></div>

<script>
    const DATA_URL = 'https://script.google.com/macros/s/AKfycbws1Ec9QPxiKP6xVLJILV8Ac6SJt0rdcXUuMezRAfvLHZQMeYolh-6ZP41S7R4UTaDy/exec';
    let allData = []; let layerGroups = {}; let mainLayerControl; let chartKecamatanInstance, chartKerusakanInstance, chartKonstruksiInstance; let heatLayer;
    const map = L.map('map', { center: [-8.17, 113.70], zoom: 12, attributionControl: false });
    L.control.attribution({ position: 'bottomleft' }).addTo(map);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri' });
    const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '© CARTO' });
    const terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: '© OpenTopoMap' });
    const labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { attribution: '© CARTO', pane: 'labels' });
    const hybrid = L.layerGroup([satellite, labels]);
    const baseMaps = { "Peta Jalan": osm, "Satelit Hybrid": hybrid, "Mode Gelap": dark, "Topografi": terrain };
    map.createPane('labels'); map.getPane('labels').style.zIndex = 650; map.getPane('labels').style.pointerEvents = 'none';
    L.control.locate({ position: 'topleft', strings: { title: "Tampilkan lokasi saya" } }).addTo(map);
    const JitupasnaControl = L.Control.extend({ onAdd: function(map) { const container = L.DomUtil.create('div'); const link = L.DomUtil.create('a', 'jitupasna-btn', container); link.href = 'https://bidangrrjember.github.io/geocode/'; link.target = '_blank'; link.title = 'Isi Laporan Jitupasna'; link.innerHTML = `<svg viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>`; L.DomEvent.disableClickPropagation(container); return container; } });
    new JitupasnaControl({ position: 'bottomright' }).addTo(map);

    const BencanaIcon = L.Icon.extend({ options: { shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] } });
    const BencanaIconLarge = L.Icon.extend({ options: { shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [38, 62], iconAnchor: [19, 62], popupAnchor: [1, -54], shadowSize: [62, 62] } });
    
    const iconRusakBerat = new BencanaIcon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png'});
    const iconRusakSedang = new BencanaIcon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png'});
    const iconRusakRingan = new BencanaIcon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png'});
    const iconRusakBeratLarge = new BencanaIconLarge({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png'});
    const iconRusakSedangLarge = new BencanaIconLarge({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png'});
    const iconRusakRinganLarge = new BencanaIconLarge({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png'});
    
    const dashboardModal = document.getElementById('dashboard-modal');
    document.getElementById('dashboard-btn').onclick = () => { if(allData.length > 0) updateDashboardCharts(allData); dashboardModal.style.display = 'block'; };
    document.querySelector('.modal-close-btn').onclick = () => { dashboardModal.style.display = 'none'; };
    window.onclick = (event) => { if (event.target == dashboardModal) { dashboardModal.style.display = 'none'; } };
    document.getElementById('search-input').addEventListener('keyup', function(event) { if (event.key === 'Enter') { const query = event.target.value.toLowerCase(); if (!query) return; const result = allData.find(item => (item.nama && item.nama.toLowerCase().includes(query)) || (item.dusun && item.dusun.toLowerCase().includes(query)) || (item.kecamatan && item.kecamatan.toLowerCase().includes(query))); if (result) { map.flyTo([result.lat, result.lng], 16); openSidebarWithData(result); } else { alert('Data tidak ditemukan.'); } } });
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    hamburgerBtn.onclick = () => { mobileMenu.style.display = (mobileMenu.style.display === 'block') ? 'none' : 'block'; };
    document.getElementById('mobile-dashboard-btn').onclick = () => { if(allData.length > 0) updateDashboardCharts(allData); dashboardModal.style.display = 'block'; mobileMenu.style.display = 'none'; };
    document.getElementById('mobile-search-input').addEventListener('keyup', function(e) { if (e.key === 'Enter') { document.getElementById('search-input').value = this.value; document.getElementById('search-input').dispatchEvent(new KeyboardEvent('keyup', {'key': 'Enter'})); mobileMenu.style.display = 'none'; } });

    const fullscreenBtn = document.getElementById('fullscreen-btn');
    fullscreenBtn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    });

    function processMapData(data) {
        if(mainLayerControl) mainLayerControl.remove();
        Object.values(layerGroups).forEach(lg => lg.clearLayers());
        let overlayMaps = {};
        const heatPoints = data.map(item => [item.lat, item.lng, 0.5]);
        if (!heatLayer) { heatLayer = L.heatLayer(heatPoints, { radius: 25 }); } else { heatLayer.setLatLngs(heatPoints); }
        const bencanaCounts = {};
        data.forEach(item => { const bencana = item.bencana || "Tidak Terkategori"; if (!layerGroups[bencana]) { layerGroups[bencana] = L.layerGroup().addTo(map); overlayMaps[bencana] = layerGroups[bencana]; } });
        
        // --- MODIFIKASI UTAMA: Event Listener Hover & Pembeda Data Baru ---
        data.forEach(item => {
            const bencana = item.bencana || "Tidak Terkategori";
            let chosenIcon = iconRusakRingan;
            let chosenLargeIcon = iconRusakRinganLarge;
            if (item.kerusakan === 'Rusak Berat') {
                chosenIcon = iconRusakBerat;
                chosenLargeIcon = iconRusakBeratLarge;
            } else if (item.kerusakan === 'Rusak Sedang') {
                chosenIcon = iconRusakSedang;
                chosenLargeIcon = iconRusakSedangLarge;
            }

            // --- PENAMBAHAN: Logika untuk membedakan data baru ---
            const now = new Date();
            const itemDate = new Date(item.tanggalWaktu);
            // Hitung selisih waktu dalam jam
            const diffHours = (now - itemDate) / (1000 * 60 * 60);
            // Cek apakah data masuk dalam 24 jam terakhir & tanggalnya valid
            const isNew = diffHours <= 24 && !isNaN(diffHours);

            let finalIcon = chosenIcon;
            let finalLargeIcon = chosenLargeIcon;
            
            // Jika data baru, buat instance ikon baru dengan class 'marker-new'
            if (isNew) {
                // Gunakan L.Icon dan L.Icon.extend untuk membuat instance baru
                finalIcon = new L.Icon({ ...chosenIcon.options, className: 'marker-new' });
                finalLargeIcon = new (L.Icon.extend({ options: chosenLargeIcon.options }))({className: 'marker-new' });
            }
            
            const marker = L.marker([item.lat, item.lng], {icon: finalIcon});
            
            marker.on('mouseover', function() { this.setIcon(finalLargeIcon); });
            marker.on('mouseout', function() { this.setIcon(finalIcon); });
            marker.on('click', () => {
                // Saat diklik, kembalikan ke ikon normal (tanpa hover)
                marker.setIcon(finalIcon); 
                openSidebarWithData(item);
            });
            
            if (layerGroups[bencana]) layerGroups[bencana].addLayer(marker);
            bencanaCounts[bencana] = (bencanaCounts[bencana] || 0) + 1;
        });

        overlayMaps["Heatmap"] = heatLayer;
        mainLayerControl = L.control.layers(baseMaps, overlayMaps, { position: 'bottomright' }).addTo(map);
        
        const summaryContent = document.getElementById('summary-content-wrapper').querySelector('#summary-content');
        const mobileSummaryContent = document.getElementById('mobile-summary-content');
        summaryContent.innerHTML = ''; mobileSummaryContent.innerHTML = '';
        for (const bencana in bencanaCounts) { const count = bencanaCounts[bencana]; const statHTML = `<div class="stat-item"><span>${bencana}:</span> <span>${count}</span></div>`; summaryContent.innerHTML += statHTML; mobileSummaryContent.innerHTML += statHTML; }
        document.getElementById('stat-total').innerText = data.length;
        document.getElementById('mobile-stat-total').innerText = data.length;
    }
    
    function updateDashboardCharts(data) {
        if(chartKecamatanInstance) chartKecamatanInstance.destroy(); if(chartKerusakanInstance) chartKerusakanInstance.destroy(); if(chartKonstruksiInstance) chartKonstruksiInstance.destroy();
        const kecamatanCounts = data.reduce((acc, item) => { const kecamatan = item.kecamatan || "N/A"; acc[kecamatan] = (acc[kecamatan] || 0) + 1; return acc; }, {});
        chartKecamatanInstance = new Chart(document.getElementById('chartKecamatan'), { type: 'bar', data: { labels: Object.keys(kecamatanCounts), datasets: [{ label: 'Jumlah Kejadian', data: Object.values(kecamatanCounts), backgroundColor: 'rgba(54, 162, 235, 0.6)' }] } });
        const kerusakanCounts = data.reduce((acc, item) => { const kerusakan = item.kerusakan || "N/A"; acc[kerusakan] = (acc[kerusakan] || 0) + 1; return acc; }, {});
        chartKerusakanInstance = new Chart(document.getElementById('chartKerusakan'), { type: 'doughnut', data: { labels: Object.keys(kerusakanCounts), datasets: [{ data: Object.values(kerusakanCounts), backgroundColor: ['rgba(255, 99, 132, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(75, 192, 192, 0.6)'] }] } });
        const konstruksiData = { 'Permanen': {}, 'Semi Permanen': {}, 'Non Permanen': {} }; const kerusakanTypes = ['Rusak Ringan', 'Rusak Sedang', 'Rusak Berat'];
        for(const k in konstruksiData) { kerusakanTypes.forEach(t => konstruksiData[k][t] = 0); }
        data.forEach(item => { if (konstruksiData[item.konstruksi] && item.kerusakan) { konstruksiData[item.konstruksi][item.kerusakan]++; } });
        chartKonstruksiInstance = new Chart(document.getElementById('chartKonstruksi'), { type: 'bar', data: { labels: ['Permanen', 'Semi Permanen', 'Non Permanen'], datasets: [ { label: 'Rusak Ringan', data: [konstruksiData['Permanen']['Rusak Ringan'], konstruksiData['Semi Permanen']['Rusak Ringan'], konstruksiData['Non Permanen']['Rusak Ringan']], backgroundColor: 'rgba(75, 192, 192, 0.6)' }, { label: 'Rusak Sedang', data: [konstruksiData['Permanen']['Rusak Sedang'], konstruksiData['Semi Permanen']['Rusak Sedang'], konstruksiData['Non Permanen']['Rusak Sedang']], backgroundColor: 'rgba(255, 206, 86, 0.6)' }, { label: 'Rusak Berat', data: [konstruksiData['Permanen']['Rusak Berat'], konstruksiData['Semi Permanen']['Rusak Berat'], konstruksiData['Non Permanen']['Rusak Berat']], backgroundColor: 'rgba(255, 99, 132, 0.6)' } ] }, options: { scales: { x: { stacked: true }, y: { stacked: true } } } });
        const bantuanLabels = [ "Semen", "Batu Bata", "Genteng", "Kalsiboard", "Kayu Balok", "Kayu Usuk", "Kayu Reng", "Besi ø 6 mm", "Besi ø 10 mm", "Terpal 3x4m", "Terpal 5x6m" ];
        const totalBantuan = {};
        bantuanLabels.forEach(label => totalBantuan[label] = 0);
        data.forEach(item => { if (item.bantuan && typeof item.bantuan === 'object') { for (const material in item.bantuan) { if(totalBantuan.hasOwnProperty(material)) { totalBantuan[material] += parseFloat(item.bantuan[material]) || 0; } } } });
        const tableContainer = document.getElementById('bantuan-table-container');
        let tableHTML = `<table class="bantuan-table"><tr>`;
        for (const material in totalBantuan) { tableHTML += `<th>${material}</th>`; }
        tableHTML += `</tr><tr>`;
        for (const material in totalBantuan) { tableHTML += `<td>${totalBantuan[material]}</td>`; }
        tableHTML += `</tr></table>`;
        tableContainer.innerHTML = `<h5>Total Bantuan Stimulan Diberikan</h5>${tableHTML}`;
    }

    function fetchData() { fetch(DATA_URL).then(r => r.json()).then(data => { document.getElementById('loader').style.display = 'none'; if (allData.length > 0 && data.length > allData.length) { const newData = data[data.length - 1]; map.flyTo([newData.lat, newData.lng], 15); showNotification(`Laporan baru masuk: ${newData.nama}`); } allData = data; processMapData(allData); }).catch(error => console.error('Gagal mengambil data:', error)); }
    function showNotification(message) { const notification = document.getElementById('notification'); notification.innerText = message; notification.style.display = 'block'; setTimeout(() => { notification.style.display = 'none'; }, 5000); }
    function openSidebarWithData(data) { const content = document.getElementById('sidebar-content'); const sidebarTitle = document.getElementById('sidebar-header').querySelector('h3'); const routeButton = document.getElementById('route-button-link'); const downloadButton = document.getElementById('download-laporan-btn'); let galleryHtml = '', bantuanHtml = ''; if (data.bantuan && typeof data.bantuan === 'object') { let adaBantuan = false; let bantuanContent = ''; for (const item in data.bantuan) { const jumlah = parseFloat(data.bantuan[item]) || 0; if (jumlah > 0) { adaBantuan = true; bantuanContent += `<p><strong>${item}:</strong> ${jumlah}</p>`; } } if (adaBantuan) { bantuanHtml = `<h4>Detail Bantuan Stimulan</h4>${bantuanContent}`; } } if (data.photos && data.photos.length > 0) { galleryHtml += '<h4>Dokumentasi Foto</h4><div class="sidebar-gallery">'; data.photos.forEach((photoUrl, index) => { if(photoUrl){ galleryHtml += `<a href="${photoUrl}" target="_blank" class="photo-link" title="Buka foto di tab baru">📷 Foto ${index + 1}</a>`; } }); galleryHtml += '</div>'; } const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${data.lat},${data.lng}`; sidebarTitle.innerText = data.nama || 'Detail Laporan'; content.innerHTML = `<h4>Detail Lokasi</h4><p><strong>Jalan/Dusun:</strong><br>${data.dusun||'Tidak ada data'}</p><p><strong>Kelurahan/Desa:</strong><br>${data.kelurahan||'Tidak ada data'}</p><p><strong>Kecamatan:</strong><br>${data.kecamatan||'Tidak ada data'}</p><h4>Detail Bencana & Asesmen</h4><p><strong>Jenis Bencana:</strong><br>${data.bencana||'Tidak ada data'}</p><p><strong>Waktu Asesmen:</strong><br>${data.hari||''}, ${data.tanggalWaktu||''}</p><p><strong>Pengkajian:</strong><br>${data.pengkajian||'Tidak ada data'}</p><h4>Detail Kerusakan & Kerugian</h4><p><strong>Tingkat Kerusakan:</strong><br>${data.kerusakan||'Tidak ada data'}</p><p><strong>Bagian Rusak:</strong><br>${data.bagianRusak||'Tidak ada data'}</p><p><strong>Taksiran Kerusakan:</strong><br>${data.nilaiKerusakan||'Tidak ada data'}</p><p><strong>Taksiran Kerugian:</strong><br>${data.nilaiKerugian||'Tidak ada data'}</p>${bantuanHtml}${galleryHtml}`; routeButton.href = googleMapsUrl; if (data.linkDokumen) { downloadButton.href = data.linkDokumen; downloadButton.style.display = 'inline-block'; } else { downloadButton.style.display = 'none'; } document.getElementById('sidebar').classList.add('visible'); }
    function closeSidebar() { document.getElementById('sidebar').classList.remove('visible'); }
    
    fetchData(); setInterval(fetchData, 5000);
</script>

</body>
</html>