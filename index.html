<!DOCTYPE html>
<html lang="id" class="light">
<head>
    <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> <title>Dashboard Peta Bencana</title> <link rel="icon" href="https://bidangrrjember.github.io/peta-bencana-jember/logo-bpbd.png" type="image/png"> <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/> <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css" /> <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js" charset="utf-8"></script> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script> <script src="https://npmcdn.com/flatpickr/dist/l10n/id.js"></script> <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script> <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script> <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" /> <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/> <script>
      //
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#007BFF",
              "background-light": "#F6F7F9",
              "background-dark": "#121212",
              "card-light": "#FFFFFF",
              "card-dark": "#1E1E1E",
              "text-light": "#333333",
              "text-dark": "#EAEAEA",
              "border-light": "#E0E0E0",
              "border-dark": "#333333"
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {
              "DEFAULT": "0.75rem", // Disesuaikan sedikit
              "lg": "1rem",
              "xl": "1.5rem"
            },
          },
        },
      }
    </script>

    <style>
      /* */
      body {
        font-family: 'Inter', sans-serif;
        overflow-y: hidden; /* Mencegah double scrollbar */

      }
      /* */
      .leaflet-pane[style*="z-index: 650"] {
        pointer-events: none;
      }

      .dot {
        width: 12px; /* Ukuran titik */
        height: 12px;
        background-color: #007BFF; /* Warna titik (primary color) */
        border-radius: 50%;
      }

      /* Animasi */
      @keyframes loader-dot-pulse {
        0%, 80%, 100% {
          transform: scale(0);
          opacity: 0.5;
        }
        40% {
          transform: scale(1.0);
          opacity: 1;
        }
      }

      .animate-loader-dot {
        animation: loader-dot-pulse 1.4s infinite ease-in-out both;
      }

      /* Delay untuk titik kedua dan ketiga */
      .animation-delay-200 {
        animation-delay: 0.16s;
      }
      .animation-delay-400 {
        animation-delay: 0.32s;
      }

      .no-scrollbar::-webkit-scrollbar {
    	display: none;
      }
      .no-scrollbar {
    	-ms-overflow-style: none;  /* IE dan Edge */
        scrollbar-width: none;  /* Firefox */
      }
     
      /* */
      @keyframes pulse-glow {
        0% { 
          filter: drop-shadow(0 0 2px rgba(23, 162, 184, 0.7)); 
          /* opacity: 0.7; (Opsional: buat ikon sedikit transparan di awal) */
        } 
        70% { 
          filter: drop-shadow(0 0 10px rgba(23, 162, 184, 0)); /* Glow menyebar */
          /* opacity: 1; (Opsional: kembali normal) */
        }
        100% { 
          filter: drop-shadow(0 0 2px rgba(23, 162, 184, 0)); 
          /* opacity: 0.7; (Opsional: kembali transparan) */
        }
      }

      .marker-new img {
        animation: pulse-glow 2s infinite;
      }
      /* Perbaikan z-index untuk Leaflet controls agar di atas sidebar detail */
      .leaflet-control-container {
        z-index: 10 !important;
      }

.flatpickr-month {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        height: 40px !important; /* Tinggi kompak */
        padding: 0 10px !important;
        position: relative !important;
        overflow: visible !important;
        margin-bottom: 5px !important;
    }

    /* Sembunyikan Panah Kiri/Kanan */
    .flatpickr-prev-month, .flatpickr-next-month {
        display: none !important; 
    }

    /* Container Teks Tengah */
    .flatpickr-current-month {
        position: static !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: 100% !important; 
        padding: 0 !important;
    }

    /* === 2. FIX DROPDOWN BULAN & TAHUN (THEMING) === */
    
    /* Style Dasar Input Select & Tahun */
    .flatpickr-current-month .flatpickr-monthDropdown-months,
    .flatpickr-current-month input.cur-year {
        font-family: 'Inter', sans-serif !important;
        font-weight: 600 !important;
        font-size: 0.95rem !important;
        color: inherit !important;
        appearance: none !important;        /* Hilangkan panah bawaan browser */
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        background: transparent !important;
        border: none !important;
        padding: 2px 4px !important;
        margin: 0 !important;
        cursor: pointer !important;
        outline: none !important;            /* Hilangkan garis biru saat diklik */
    }
    
    /* Hilangkan spinner pada input tahun */
    .flatpickr-current-month .numInputWrapper span { display: none !important; }
    
    /* Hover Effect untuk Judul */
    .flatpickr-current-month .flatpickr-monthDropdown-months:hover,
    .flatpickr-current-month input.cur-year:hover {
        background-color: rgba(0,0,0,0.05) !important;
        border-radius: 4px !important;
    }
    html.dark .flatpickr-current-month .flatpickr-monthDropdown-months:hover,
    html.dark .flatpickr-current-month input.cur-year:hover {
        background-color: rgba(255,255,255,0.1) !important;
    }

    /* >>> BAGIAN PENTING: WARNA ISI DROPDOWN (OPTIONS) <<< */
    
    /* Default (Light Mode) - Latar Putih, Teks Gelap */
    .flatpickr-monthDropdown-months option {
        background-color: #FFFFFF !important;
        color: #333333 !important;
        padding: 10px !important;
        font-size: 0.9rem !important;
    }

    /* Dark Mode - Latar Gelap, Teks Terang */
    html.dark .flatpickr-monthDropdown-months option {
        background-color: #1E1E1E !important; /* Warna Card Dark */
        color: #EAEAEA !important;
    }


    /* === 3. CONTAINER UTAMA KALENDER === */
    .flatpickr-calendar {
        font-family: 'Inter', sans-serif !important;
        border-radius: 0.75rem !important;
        border: none !important;
        width: 330px !important;
        padding: 6px 12px 12px 12px !important; 
        margin-top: 8px !important;
    }
    .flatpickr-calendar:before, .flatpickr-calendar:after { display: none !important; }

    .flatpickr-innerContainer, .flatpickr-rContainer, .dayContainer, .flatpickr-weekdays {
        width: 100% !important;
    }
    .flatpickr-weekdays { margin-bottom: 8px !important; }
    
    span.flatpickr-weekday {
        font-size: 0.8rem !important;
        font-weight: 500 !important;
        color: #9CA3AF !important;
    }

    .flatpickr-day {
        border-radius: 0.5rem !important;
        font-weight: 500 !important;
        font-size: 0.95rem !important;
        height: 40px !important; 
        line-height: 40px !important;
        max-width: 40px !important;
        margin: 2px !important;
        border: 1px solid transparent !important;
    }

    /* === 4. TEMA LIGHT MODE === */
    html.light .flatpickr-calendar {
        background: #FFFFFF !important;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.01) !important;
        border: 1px solid #E5E7EB !important;
    }
    html.light .flatpickr-day { color: #374151 !important; } 
    html.light .flatpickr-month { color: #111827 !important; fill: #6B7280 !important; }
    
    html.light .flatpickr-day:hover {
        background: #EFF6FF !important; 
        color: #007BFF !important;
    }

    /* === 5. TEMA DARK MODE === */
    html.dark .flatpickr-calendar {
        background: #1E1E1E !important; 
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.2) !important;
        border: 1px solid #333333 !important; 
    }
    html.dark .flatpickr-month { color: #EAEAEA !important; fill: #9CA3AF !important; }
    html.dark .flatpickr-day { color: #D1D5DB !important; }
    
    html.dark .flatpickr-day:hover {
        background: rgba(0, 123, 255, 0.15) !important; 
        color: #007BFF !important;
    }

    /* === 6. SELEKSI (WARNA BIRU) === */
    .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, 
    .flatpickr-day.selected:focus, .flatpickr-day.selected:hover {
        background: #007BFF !important;
        border-color: #007BFF !important;
        color: #FFFFFF !important;
        box-shadow: 0 4px 10px -2px rgba(0, 123, 255, 0.5) !important;
    }

      /* === CSS BARU UNTUK LAYER CONTROL DARK MODE === */
      /* Style dasar (Light mode - ini mungkin sudah ada/default) */
      .leaflet-control-layers {
        background-color: white; /* Background putih */
        box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        border-radius: 5px;
      }
      .leaflet-control-layers a {
         /* Icon default Leaflet menggunakan background-image,
            jadi kita tidak bisa langsung ganti warna ikonnya
            dengan 'color'. Tapi kita bisa pastikan teks (jika ada)
            dan background-nya kontras. */
         color: #333; /* Warna teks (jika ada) gelap */
      }
      .leaflet-control-layers-separator {
          border-top: 1px solid #ddd; /* Garis pemisah terang */
      }
      .leaflet-control-layers-selector { /* Checkbox/radio */
        vertical-align: middle;
      }
      .leaflet-control-layers label {
        color: #333; /* Warna label terang */
        display: inline-block; /* Agar padding bekerja */
        padding: 4px 6px;
      }

      /* Style Dark Mode */
      .dark .leaflet-control-layers {
        background-color: #1E1E1E; /* Background gelap (card-dark) */
        box-shadow: 0 1px 5px rgba(255, 255, 255, 0.2); /* Shadow lebih terang */
        border: 1px solid #333333; /* Border gelap (border-dark) */
      }
      .dark .leaflet-control-layers a {
        /* Ikon Leaflet default mungkin tetap gelap, kontrasnya mungkin kurang ideal */
         color: #EAEAEA; /* Warna teks (jika ada) terang */
      }
       .dark .leaflet-control-layers-separator {
          border-top: 1px solid #333333; /* Garis pemisah gelap */
      }
       .dark .leaflet-control-layers label {
        color: #EAEAEA; /* Warna label gelap */
      }
      /* === AKHIR CSS LAYER CONTROL === */

      /* Scrollbar kustom untuk sidebar */
      .custom-scrollbar::-webkit-scrollbar { width: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #c4c4c4; border-radius: 4px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }

      

      #loader {
        /* Style loader Anda yg lama (position, z-index, dll.)
           ATAU style loader titik (position, display: flex, background, z-index) */
        opacity: 1; /* Awalnya terlihat */
 	transition: opacity 0.5s ease-out;
  	z-index: 2147483647;
        transition: opacity 0.5s ease-out; /* Efek fade 0.5 detik */
      }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark font-display select-none">
    
<div id="loader" class="fixed top-0 left-0 w-full h-full flex items-center justify-center bg-background-light dark:bg-background-dark z-[9999]">
    <div class="flex space-x-2">
        <div class="dot animate-loader-dot"></div>
        <div class="dot animate-loader-dot animation-delay-200"></div>
        <div class="dot animate-loader-dot animation-delay-400"></div>
    </div>
</div>

    <div id="notification" class="hidden fixed top-24 left-1/2 -translate-x-1/2 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg z-[9998] transition-all duration-500 ease-in-out"></div>

<audio id="notification-sound" preload="auto">
        <source src="https://bidangrrjember.github.io/peta-bencana-jember/notification-sound.mp3" type="audio/mpeg">
        Browser Anda tidak mendukung elemen audio.
    </audio>
    
    <div class="flex h-screen">
        <aside id="filter-sidebar" class="fixed lg:static w-64 bg-card-light dark:bg-card-dark flex flex-col p-6 border-r border-border-light dark:border-border-dark h-full z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            
            <div class="flex items-center justify-between gap-3 mb-8">
                <div class="flex items-center gap-3">
                    <img src="https://bidangrrjember.github.io/peta-bencana-jember/logo-bpbd.png" alt="Logo" class="h-8 w-8"> <h1 class="text-xl font-bold text-text-light dark:text-text-dark">BPBD Jember</h1>
                </div>
                <button id="close-filter-btn" class="lg:hidden text-gray-500 dark:text-gray-400">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto no-scrollbar">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-sm font-semibold uppercase text-gray-500 dark:text-gray-400">Filter Data</h2>
        <button onclick="resetAllFilters()" class="text-xs text-primary hover:text-blue-600 font-medium transition-colors">
            Reset Filter
        </button>
    </div>
    
    <div class="space-y-6 pb-20"> <div class="relative z-30">
    <h3 class="text-sm font-medium mb-3 flex items-center gap-2">
        <span class="material-symbols-outlined text-base text-gray-400">date_range</span> Rentang Waktu
    </h3>
    <div class="flex flex-col space-y-3">
        
        <div class="relative">
            <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Dari Tanggal</label>
            <div class="relative group">
                <input type="text" id="filter-start-date" placeholder="Pilih Tanggal..." readonly="readonly"
                    class="w-full text-sm pl-4 pr-10 py-3 bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-xl focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all text-text-light dark:text-text-dark cursor-pointer group-hover:border-primary">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <span class="material-symbols-outlined text-gray-400 text-lg group-hover:text-primary transition-colors">calendar_today</span>
                </div>
            </div>
        </div>

        <div class="relative">
            <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Sampai Tanggal</label>
            <div class="relative group">
                <input type="text" id="filter-end-date" placeholder="Pilih Tanggal..." readonly="readonly"
                    class="w-full text-sm pl-4 pr-10 py-3 bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-xl focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all text-text-light dark:text-text-dark cursor-pointer group-hover:border-primary">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <span class="material-symbols-outlined text-gray-400 text-lg group-hover:text-primary transition-colors">event</span>
                </div>
            </div>
        </div>

    </div>
</div>

        <div class="mb-4 relative z-20"> 
            <h3 class="text-sm font-medium mb-3 flex items-center gap-2">
                <span class="material-symbols-outlined text-base text-gray-400">flood</span> Jenis Bencana
            </h3>
            
            <input type="hidden" id="filter-bencana" value="all">

            <button id="btn-dropdown-bencana" onclick="toggleDropdown('bencana')" 
                class="w-full flex items-center justify-between text-sm px-4 py-3 bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-xl hover:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-text-light dark:text-text-dark group text-left">
                <span id="label-dropdown-bencana" class="truncate">Semua Jenis Bencana</span>
                <span id="arrow-bencana" class="material-symbols-outlined text-gray-400 transition-transform duration-300 group-hover:text-primary">expand_more</span>
            </button>

            <div id="menu-dropdown-bencana" 
                class="hidden absolute top-full left-0 right-0 mt-2 bg-white dark:bg-[#1E1E1E] border border-gray-100 dark:border-gray-700 rounded-xl shadow-xl overflow-hidden z-50 transform origin-top transition-all duration-200">
                <div class="max-h-60 overflow-y-auto no-scrollbar p-1 space-y-1" id="list-bencana"></div>
            </div>
        </div>

        <div class="mb-4 relative z-10">
            <h3 class="text-sm font-medium mb-3 flex items-center gap-2">
                <span class="material-symbols-outlined text-base text-gray-400">map</span> Kecamatan
            </h3>
            
            <input type="hidden" id="filter-kecamatan" value="all">

            <button id="btn-dropdown-kecamatan" onclick="toggleDropdown('kecamatan')" 
                class="w-full flex items-center justify-between text-sm px-4 py-3 bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark rounded-xl hover:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all text-text-light dark:text-text-dark group text-left">
                <span id="label-dropdown-kecamatan" class="truncate">Semua Kecamatan</span>
                <span id="arrow-kecamatan" class="material-symbols-outlined text-gray-400 transition-transform duration-300 group-hover:text-primary">expand_more</span>
            </button>

            <div id="menu-dropdown-kecamatan" 
                class="hidden absolute top-full left-0 right-0 mt-2 bg-white dark:bg-[#1E1E1E] border border-gray-100 dark:border-gray-700 rounded-xl shadow-xl overflow-hidden z-50 transform origin-top transition-all duration-200">
                <div class="p-2 border-b border-gray-100 dark:border-gray-700 sticky top-0 bg-white dark:bg-[#1E1E1E] z-10">
                    <input type="text" id="search-kecamatan-input" placeholder="Cari kecamatan..." 
                           class="w-full text-xs px-3 py-2 rounded-lg bg-gray-50 dark:bg-gray-800 border-none focus:ring-1 focus:ring-primary text-text-light dark:text-text-dark placeholder-gray-400">
                </div>
                <div class="max-h-60 overflow-y-auto no-scrollbar p-1 space-y-1" id="list-kecamatan"></div>
            </div>
        </div>

    </div>
</div>

	<div id="weather-forecast-container" 
     class="p-6 border-t border-border-light dark:border-border-dark">
  <h3 class="text-sm font-semibold uppercase text-gray-500 dark:text-gray-400 mb-4">
    Prakiraan Cuaca
  </h3>
  <div class="flex items-center gap-4 mb-3">
    <span id="weather-icon" class="material-symbols-outlined text-5xl text-primary">
      hourglass_empty
    </span>
    <div>
      <p id="weather-temp" class="text-3xl font-bold">--°C</p>
      <p id="weather-desc" class="text-sm text-gray-500 dark:text-gray-400">
        Memuat...
      </p>
    </div>
  </div>
  <p id="weather-range" class="text-xs text-gray-500 dark:text-gray-400 mb-3">
    Tertinggi: --° / Terendah: --°
  </p>
  <p class="text-[10px] text-gray-400 dark:text-gray-500">
    Didukung oleh 
    <a href="https://open-meteo.com/" target="_blank" class="underline hover:text-primary">
      Open-Meteo.com
    </a>
  </p>
</div>


        </aside>

        <div id="filter-overlay" class="fixed inset-0 bg-black/30 z-40 lg:hidden hidden"></div>


        <main class="flex-1 flex flex-col overflow-hidden h-screen relative">
            
            <header class="flex items-center justify-between p-4 lg:p-6 border-b border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark">
            
    <div class="flex items-center gap-4">
        <button id="hamburger-btn" class="lg:hidden text-text-light dark:text-text-dark flex size-10 shrink-0 items-center justify-center">
            <span class="material-symbols-outlined text-2xl">menu</span>
        </button>
        <h1 class="text-xl lg:text-2xl font-bold text-text-light dark:text-text-dark hidden sm:block">
            Peta Monitoring Pengkajian Kebutuhan Pasca Bencana
        </h1>
    </div>

<div class="flex items-center justify-end gap-4">
        
        <div class="hidden lg:grid relative grid-cols-2 items-center p-1 w-64 bg-background-light dark:bg-background-dark rounded-lg border border-border-light dark:border-border-dark">
    
    <div id="nav-pill" class="absolute top-1 bottom-1 left-1 w-[calc(50%-0.25rem)] bg-card-light dark:bg-card-dark rounded shadow-sm transition-transform duration-300 ease-in-out z-0 translate-x-0"></div>

    <button id="nav-dashboard" onclick="switchView('dashboard')" 
       class="relative z-10 flex items-center justify-center gap-2 py-1.5 rounded text-sm font-medium transition-colors duration-300 text-primary hover:text-primary dark:hover:text-primary">
        <span class="material-symbols-outlined text-lg" style="font-variation-settings: 'FILL' 1;">dashboard</span>
        <span>Dashboard</span>
    </button>
    
    <button id="nav-reports" onclick="switchView('reports')" 
       class="relative z-10 flex items-center justify-center gap-2 py-1.5 rounded text-sm font-medium transition-colors duration-300 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100">
        <span class="material-symbols-outlined text-lg">bar_chart</span>
        <span>Reports</span>
            </a>

        </div>
        <button id="fullscreen-btn" title="Mode Layar Penuh" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-700 text-text-light dark:text-text-dark">
            <span class="material-symbols-outlined">fullscreen</span>
        </button>
        <button id="theme-toggle" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-700 text-text-light dark:text-text-dark">
            <span class="material-symbols-outlined dark:hidden">dark_mode</span>
            <span class="material-symbols-outlined hidden dark:inline">light_mode</span>
        </button>
    </div>

</header>

            <div class="flex-1 p-4 lg:p-6 overflow-hidden bg-background-light dark:bg-background-dark flex flex-col">
    
    <div id="dashboard-view" class="transition-all duration-300 ease-in-out opacity-100 scale-100 origin-top">
        
        <div id="summary-box" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
             <div class="flex flex-col gap-2 rounded-lg p-6 bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark shadow-sm">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <p class="text-base font-medium text-gray-500 dark:text-gray-400">Menunggu Penyaluran</p>
                </div>
                <p id="stat-terkaji" class="text-3xl font-bold">0</p>
            </div>
        
            <div class="flex flex-col gap-2 rounded-lg p-6 bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark shadow-sm">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                    <p class="text-base font-medium text-gray-500 dark:text-gray-400">Menunggu Monitoring</p>
                </div>
                <p id="stat-bantuan" class="text-3xl font-bold">0</p>
            </div>
        
            <div class="flex flex-col gap-2 rounded-lg p-6 bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark shadow-sm">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                    <p class="text-base font-medium text-gray-500 dark:text-gray-400">Penanganan Tuntas</p>
                </div>
                <p id="stat-monitoring" class="text-3xl font-bold">0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <div class="xl:col-span-2">
                 
<div id="map-card" class="bg-card-light dark:bg-card-dark rounded-lg shadow-sm border border-border-light dark:border-border-dark p-2 h-96 xl:h-auto">
    <div class="relative w-full h-full">
        <div id="map" class="w-full h-full rounded-[0.5rem] z-10"></div>
        
        <div class="absolute top-4 left-4 right-4 z-30 flex flex-col">
            <label class="relative flex w-full items-stretch rounded-lg shadow-md bg-card-light dark:bg-card-dark transition-all duration-300">
                <div class="text-gray-500 dark:text-gray-400 flex border-none items-center justify-center pl-4 rounded-l-lg">
                    <span class="material-symbols-outlined">search</span>
                </div>
                
                <input id="search-input" autocomplete="off" 
                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-r-lg text-text-light dark:text-text-dark focus:outline-none focus:ring-0 border-none bg-transparent h-12 placeholder:text-gray-500 dark:placeholder:text-gray-400 pl-2 text-base font-normal" 
                    placeholder="Cari nama korban, desa, atau kecamatan..."/>

                <button id="clear-search-btn" class="hidden text-gray-400 hover:text-red-500 pr-4 items-center justify-center">
                    <span class="material-symbols-outlined text-xl">close</span>
                </button>
            </label>

            <div id="search-results" class="hidden mt-2 w-full bg-white dark:bg-[#1E1E1E] rounded-lg shadow-xl border border-gray-100 dark:border-gray-700 max-h-80 overflow-y-auto custom-scrollbar"></div>
        </div>
    </div>
</div>
            </div>

            <div class="xl:col-span-1">
                 <div id="table-card" class="overflow-hidden rounded-lg border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark shadow-sm">
                    <div id="table-header" class="flex justify-between items-center p-4 border-b border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark">
                        <h3 class="text-lg font-bold text-[#0c141d] dark:text-white">Laporan Terbaru</h3>
                        
                        <div class="flex items-center gap-2">
                            <button id="prev-page-btn" onclick="changePage(-1)" disabled class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-primary hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                                <span class="material-symbols-outlined text-sm">chevron_left</span>
                            </button>
                            <span id="page-indicator" class="text-xs font-semibold text-gray-500 dark:text-gray-400 min-w-[30px] text-center">1</span>
                            <button id="next-page-btn" onclick="changePage(1)" disabled class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-primary hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                                <span class="material-symbols-outlined text-sm">chevron_right</span>
                            </button>
                        </div>
                    </div>
                    
                    <div id="table-scroll-container" class="overflow-x-auto overflow-y-scroll no-scrollbar"> 
                        <table class="w-full text-sm text-left table-fixed"> 
                            <thead class="bg-background-light dark:bg-background-dark sticky top-0 z-10">
                                <tr>
                                    <th class="w-6/12 px-4 py-3 font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider text-left">Lokasi (Korban)</th>
                                    <th class="w-3/12 px-4 py-3 font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider text-left">Status</th>
                                    <th class="w-3/12 px-4 py-3 font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider text-left">Tanggal</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body" class="divide-y divide-border-light dark:divide-border-dark">
                                <tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div> 
    

<div id="reports-view" class="hidden w-full flex-1 flex flex-col gap-4 overflow-hidden transition-all duration-300 ease-in-out opacity-0 scale-95 origin-top p-1">
    
    <div class="flex-1 min-h-0 flex flex-col bg-white dark:bg-card-dark p-6 rounded-lg border border-border-light dark:border-border-dark shadow-sm">
        <h4 class="font-bold text-gray-700 dark:text-gray-200 mb-4 flex items-center gap-2 text-base shrink-0">
            <span class="material-symbols-outlined text-primary">ssid_chart</span> Tren Kejadian Bencana (Bulanan)
        </h4>
        <div class="relative flex-1 w-full min-h-0">
            <canvas id="chartTrenBulanan"></canvas>
        </div>
    </div>

    <div class="flex-1 min-h-0 grid grid-cols-1 lg:grid-cols-3 gap-4">
        
        <div class="flex flex-col overflow-hidden bg-white dark:bg-card-dark p-6 rounded-lg border border-border-light dark:border-border-dark shadow-sm">
            <h4 class="font-bold text-gray-700 dark:text-gray-200 mb-4 flex items-center gap-2 text-base shrink-0">
                <span class="material-symbols-outlined text-red-500">pie_chart</span> Statistik Tingkat Kerusakan
            </h4>
            <div class="relative flex-1 flex justify-center items-center min-h-0">
                <canvas id="chartTingkatKerusakan"></canvas>
            </div>
        </div>

        <div class="lg:col-span-2 flex flex-col overflow-hidden bg-white dark:bg-card-dark p-6 rounded-lg border border-border-light dark:border-border-dark shadow-sm">
            <h4 class="font-bold text-gray-700 dark:text-gray-200 mb-4 flex items-center gap-2 text-base shrink-0">
                <span class="material-symbols-outlined text-orange-500">foundation</span> Kerentanan Bangunan (Konstruksi)
            </h4>
            <div class="relative flex-1 w-full min-h-0">
                <canvas id="chartKonstruksi"></canvas>
            </div>
        </div>
    </div>

    <div class="shrink-0 bg-white dark:bg-card-dark rounded-lg border border-border-light dark:border-border-dark shadow-sm overflow-hidden mb-1">
        
        <div class="p-4 border-b border-border-light dark:border-border-dark bg-gray-50/50 dark:bg-gray-800/20 flex justify-between items-center">
             <h4 class="font-bold text-gray-800 dark:text-gray-100 flex items-center gap-2 text-base">
                <span class="material-symbols-outlined text-green-600">inventory_2</span> Distribusi Logistik
             </h4>
        </div>
        
        <div class="overflow-x-auto custom-scrollbar">
            <table class="w-full text-sm text-center border-collapse whitespace-nowrap">
                <thead id="material-table-head" class="bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 font-bold text-xs uppercase tracking-wider">
                    </thead>
                <tbody id="material-table-body" class="bg-white dark:bg-card-dark text-gray-800 dark:text-gray-200">
                    </tbody>
            </table>
        </div>
    </div>

</div>

</div>


<a href="https://bidangrrjember.github.io/jitupasna/" id="open-form-btn"
   class="fixed bottom-6 right-6 lg:bottom-10 lg:right-10 flex items-center justify-center
          w-14 h-14 bg-primary text-white rounded-full shadow-2xl shadow-blue-500/50
          transition-all duration-300 ease-in-out z-[30]
          hover:scale-110 active:scale-95 
          opacity-100 scale-100"
   title="E-Form JITUPASNA">
    <span class="material-symbols-outlined text-3xl">add</span>
</a>	

        </main>

        <div id="sidebar" class="fixed top-0 right-0 w-full max-w-md h-full bg-card-light dark:bg-card-dark shadow-2xl z-40
                                flex flex-col transform translate-x-full transition-transform duration-300 ease-in-out">
            <div id="sidebar-header" class="p-5 flex justify-between items-center border-b border-border-light dark:border-border-dark flex-shrink-0">
                <h3 id="sidebar-title" class="text-lg font-bold">Detail Laporan</h3>
                <button class="close-btn text-3xl font-light text-gray-500 hover:text-red-500" onclick="closeSidebar()">×</button>
            </div>
            <div id="sidebar-content" class="p-5 overflow-y-auto flex-1 custom-scrollbar space-y-4">
                </div>
            <div id="sidebar-footer" class="p-6 border-t border-border-light dark:border-border-dark bg-white dark:bg-card-dark flex flex-col gap-3 z-20">
    
    <a href="#" id="download-laporan-btn" target="_blank" 
       class="hidden w-full items-center justify-center gap-2 px-6 py-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold shadow-lg shadow-emerald-600/20 transition-all duration-200 hover:scale-[1.02] active:scale-95 group">
        <span class="material-symbols-outlined group-hover:animate-bounce">description</span>
        <span>Unduh Laporan JITUPASNA</span>
    </a>

    <a href="#" id="route-button-link" target="_blank" 
       class="flex w-full items-center justify-center gap-2 px-6 py-4 bg-primary hover:bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 transition-all duration-200 hover:scale-[1.02] active:scale-95 group">
        <span class="material-symbols-outlined group-hover:rotate-45 transition-transform duration-300">directions</span>
        <span>Buka Rute Lokasi</span>
    </a>

</div>
        </div>

    </div>


    <div id="dashboard-modal" class="hidden fixed z-50 inset-0 bg-black/60 flex items-start justify-center p-4 sm:p-8">
        <div class="modal-content bg-card-light dark:bg-card-dark w-full mx-auto my-4 sm:my-8 p-6 rounded-lg shadow-xl relative flex flex-col max-h-[90vh]">
            <div class="modal-header flex justify-between items-center border-b border-border-light dark:border-border-dark pb-3 mb-5">
                <h2 class="text-2xl font-bold">Analisis Data Bencana</h2>
                <button class="modal-close-btn text-3xl font-light text-gray-500 hover:text-red-500">×</button>
            </div>
            
            <div class="chart-grid grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-y-auto custom-scrollbar flex-1 min-h-0">
                <div class="chart-container p-4 rounded-lg border border-border-light dark:border-border-dark shadow-sm">
                    <h5 class="text-center font-semibold mb-3">Total Bencana per Kecamatan</h5>
                    <canvas id="chartKecamatan"></canvas>
                </div>
                <div class="chart-container p-4 rounded-lg border border-border-light dark:border-border-dark shadow-sm">
                    <h5 class="text-center font-semibold mb-3">Total Bencana per Tingkat Kerusakan</h5>
                    <canvas id="chartKerusakan"></canvas>
                </div>
                <div class="chart-container p-4 rounded-lg border border-border-light dark:border-border-dark shadow-sm">
                    <h5 class="text-center font-semibold mb-3">Kerusakan per Jenis Konstruksi</h5>
                    <canvas id="chartKonstruksi"></canvas>
                </div>
                <div class="chart-container p-4 rounded-lg border border-border-light dark:border-border-dark shadow-sm lg:col-span-3 force-bantuan-layout" id="bantuan-table-container">
    <h5 class="text-center font-semibold mb-3">Total Bantuan Stimulan Diberikan</h5>
    <style>
        /* Target khusus untuk layout bantuan */
        .force-bantuan-layout .bantuan-table-wrapper {
            overflow-x: auto !important; /* Paksa scroll horizontal */
            width: 100% !important;
            -webkit-overflow-scrolling: touch;
        }
        .force-bantuan-layout .bantuan-table {
            width: 100% !important; /* Paksa tabel mengisi wrapper */
            border-collapse: collapse !important;
            margin-top: 10px !important;
            table-layout: auto !important; /* Biarkan browser atur kolom */
        }
        .force-bantuan-layout .bantuan-table th,
        .force-bantuan-layout .bantuan-table td {
            border: 1px solid #E0E0E0 !important;
            padding: 6px 8px !important;
            text-align: center !important;
            font-size: 0.9em !important;
            white-space: nowrap !important; /* Paling penting: jangan potong teks */
        }
        .force-bantuan-layout .bantuan-table th {
            background-color: #F6F7F9 !important;
            font-weight: 500 !important;
            position: sticky !important; /* Header tetap di atas */
            top: 0;
            z-index: 1;
        }
        /* Style Dark Mode (juga dipaksa) */
        .dark .force-bantuan-layout .bantuan-table th,
        .dark .force-bantuan-layout .bantuan-table td {
            border-color: #333333 !important;
        }
        .dark .force-bantuan-layout .bantuan-table th {
            background-color: #1E1E1E !important;
        }
    </style>
    <div class="bantuan-table-wrapper">
        <table class="bantuan-table">
            </table>
    </div>
</div>
            </div>
        </div>
    </div>


    <script>
        // =============================================
        // SKRIP DARI KODE UTAMA (Fungsionalitas Inti)
        //
        // =============================================

        // --- Variabel Global ---
        const DATA_URL = 'https://script.google.com/macros/s/AKfycbwVwVGoNS_QlyjtpBwoQFS6Vp8IBLe-r9OmzqWEwRL74ZNcmAT-fz8k-EhXeaXNFsXS/exec'; //
        let allData = []; //
        let layerGroups = {}; //
        let mainLayerControl; //
        let chartKecamatanInstance, chartKerusakanInstance, chartKonstruksiInstance; //
        let heatLayer; //
        let currentTimeFilter = 'all'; // Variabel baru untuk filter waktu
	let currentPage = 1;
	const rowsPerPage = 50;
	let isAudioUnlocked = false;
	let fetchInterval; 

        // --- Inisialisasi Peta ---
        const map = L.map('map', { center: [-8.17, 113.70], zoom: 12, attributionControl: false, zoomControl: false }); //
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map); //
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri' }); //
        const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '© CARTO' }); //
        const terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: '© OpenTopoMap' }); //
        const labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { attribution: '© CARTO', pane: 'labels' }); //
        const hybrid = L.layerGroup([satellite, labels]); //
        const baseMaps = { "Peta Jalan": osm, "Satelit Hybrid": hybrid, "Mode Gelap": dark, "Topografi": terrain }; //
        map.createPane('labels'); map.getPane('labels').style.zIndex = 650; //
        
        // --- Kontrol Tombol Jitupasna ---
        //

        // --- Definisi Ikon Marker ---
        //
        // --- Definisi Ikon Marker ---
        
        // 1. Buat Ikon Kustom Bulat Kuning
        const iconTerkaji = L.divIcon({
            html: `<span style="background-color: #DC2626; width: 1.25rem; height: 1.25rem; border-radius: 50%; display: block; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.4);"></span>`,
            className: '',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });

        // 2. Ikon Kuning (Serah Terima Bantuan)
        // Menggunakan warna Tailwind 'amber-500'
        const iconSerahTerima = L.divIcon({
            html: `<span style="background-color: #F59E0B; width: 1.25rem; height: 1.25rem; border-radius: 50%; display: block; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.4);"></span>`,
            className: '',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });

        // 3. Ikon Hijau (Lokasi Monitoring)
        // Menggunakan warna Tailwind 'green-600'
        const iconMonitoring = L.divIcon({
            html: `<span style="background-color: #16A34A; width: 1.25rem; height: 1.25rem; border-radius: 50%; display: block; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.4);"></span>`,
            className: '',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });

        // --- DOM Elements ---
        // --- DOM Elements ---
        const dashboardModal = document.getElementById('dashboard-modal');
        const loader = document.getElementById('loader');
        const notification = document.getElementById('notification');
        // KODE LAMA DIHAPUS:
        // const summaryContentEl = document.getElementById('summary-content');
        // const statTotalEl = document.getElementById('stat-total');
        // KODE BARU DITAMBAHKAN:
        const statTerkajiEl = document.getElementById('stat-terkaji');
        const statBantuanEl = document.getElementById('stat-bantuan');
        const statMonitoringEl = document.getElementById('stat-monitoring');
        //
        const dataTableBody = document.getElementById('data-table-body');
        const sidebar = document.getElementById('sidebar');

        // --- Event Listener: Search ---
        //
        // ==========================================
        // SKRIP SEARCH BAR LIVE SUGGESTION (BARU)
        // ==========================================
        
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const clearSearchBtn = document.getElementById('clear-search-btn');

        // 1. Event Listener saat mengetik
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();

            // Tampilkan/Sembunyikan tombol X
            if(query.length > 0) {
                clearSearchBtn.classList.remove('hidden');
                clearSearchBtn.classList.add('flex');
            } else {
                clearSearchBtn.classList.add('hidden');
                clearSearchBtn.classList.remove('flex');
                searchResults.classList.add('hidden'); // Sembunyikan dropdown jika kosong
                return;
            }

            // Filter Data (Cari di Nama, Desa, Kecamatan, Dusun)
            const matches = allData.filter(item => {
                const nama = (item.nama || '').toLowerCase();
                const desa = (item.desakelurahan || '').toLowerCase();
                const kec = (item.kec || '').toLowerCase();
                const dusun = (item.jalandusun || '').toLowerCase();
                
                return nama.includes(query) || desa.includes(query) || kec.includes(query) || dusun.includes(query);
            });

            displayMatches(matches, query);
        });

        // 2. Fungsi Menampilkan Dropdown
        function displayMatches(matches, query) {
            if (matches.length === 0) {
                searchResults.innerHTML = `
                    <div class="p-4 text-sm text-gray-500 dark:text-gray-400 text-center">
                        Tidak ditemukan data untuk "${query}"
                    </div>`;
                searchResults.classList.remove('hidden');
                return;
            }

            // Batasi hasil maksimal 50 agar tidak berat
            const limitedMatches = matches.slice(0, 50);

            const html = limitedMatches.map(item => {
                // Tentukan lokasi (Desa/Kelurahan otomatis dari data)
                // Kita gunakan logika sederhana atau ambil raw data
                const lokasi = `${item.desakelurahan}, Kec. ${item.kec}`;
                
                // Tentukan warna ikon berdasarkan status
                let statusColor = "text-red-500"; 
                if(item.linkMonitoring) statusColor = "text-green-500";
                else if(item.linkSerahTerima) statusColor = "text-yellow-500";

                return `
                <div onclick="selectSearchResult(${item.idx})" 
                     class="flex items-center gap-3 p-3 border-b border-gray-100 dark:border-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900/30 cursor-pointer transition-colors last:border-none">
                    
                    <div class="flex-shrink-0">
                        <span class="material-symbols-outlined ${statusColor}">location_on</span>
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-gray-800 dark:text-gray-200 truncate">
                            ${item.nama}
                        </p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate">
                            ${item.jalandusun ? item.jalandusun + ', ' : ''} ${lokasi}
                        </p>
                    </div>

                    <div class="text-xs text-gray-400">
                        <span class="material-symbols-outlined text-lg">chevron_right</span>
                    </div>
                </div>
                `;
            }).join('');

            searchResults.innerHTML = html;
            searchResults.classList.remove('hidden');
        }

        // 3. Fungsi Saat Hasil Diklik
        function selectSearchResult(idx) {
            const item = allData.find(d => d.idx == idx);
            if (item) {
                // Zoom ke lokasi
                map.flyTo([item.lat, item.lng], 18);
                
                // Buka Sidebar
                openSidebarWithData(item);
                
                // Reset Pencarian
                // searchInput.value = item.nama; // Opsional: isi input dengan nama
                searchResults.classList.add('hidden'); // Tutup dropdown
            }
        }

        // 4. Tombol Clear (X)
        clearSearchBtn.addEventListener('click', () => {
            searchInput.value = '';
            searchResults.classList.add('hidden');
            clearSearchBtn.classList.add('hidden');
            clearSearchBtn.classList.remove('flex');
            searchInput.focus();
        });

        // 5. Tutup dropdown jika klik di luar
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });

        // --- Event Listener: Fullscreen ---
        //
        document.getElementById('fullscreen-btn').addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        });

        // --- Fungsi Pemrosesan Data ---

        function applyFiltersAndProcess() {
            const filteredData = getFilteredData();
            processMapData(filteredData);
           if (dashboardModal.style.display === 'flex') {
                updateDashboardCharts(filteredData);
            }
            updateDataTable(filteredData);
            
        }
	
	function unlockAudio() {
            if (!isAudioUnlocked) { // Hanya jalankan sekali
                const audio = document.getElementById('notification-sound');
                if (audio) {
                    // Coba putar suara tapi dibisukan
                    audio.muted = true;
                    audio.play().then(() => {
                        // Jika berhasil (meskipun dibisukan), set status jadi unlocked
                        isAudioUnlocked = true;
                        console.log("Audio context unlocked."); // Pesan di console (opsional)
                        // Hentikan suara yang dibisukan tadi (opsional, tapi lebih baik)
                        audio.pause();
                        audio.currentTime = 0;
                        audio.muted = false; // Kembalikan agar bisa bersuara nanti
                        // Hapus listener ini agar tidak berjalan lagi
                        document.removeEventListener('click', unlockAudio);
                        document.removeEventListener('touchstart', unlockAudio); // Juga untuk mobile
                    }).catch(error => {
                        // Jika gagal bahkan saat dibisukan, mungkin ada masalah lain
                        console.error("Gagal membuka kunci audio:", error);
                    });
                }
            }
        }

        // Tambahkan listener ke dokumen untuk klik atau sentuhan pertama
        document.addEventListener('click', unlockAudio);
        document.addEventListener('touchstart', unlockAudio);

/**
         * FUNGSI KRUSIAL 3: FILTER (getFilteredData)
         * Tugas: Membaca 'item.dateObj' untuk memfilter waktu
         */
        function getFilteredData() {
    // 1. Ambil Nilai dari Input HTML
    const startDateVal = document.getElementById('filter-start-date').value;
    const endDateVal = document.getElementById('filter-end-date').value;
    const selectedBencana = document.getElementById('filter-bencana').value;
    const selectedKecamatan = document.getElementById('filter-kecamatan').value;

    // Konversi string tanggal input ke Object Date (set jam ke 00:00:00)
    let startDate = startDateVal ? new Date(startDateVal) : null;
    if(startDate) startDate.setHours(0,0,0,0);

    let endDate = endDateVal ? new Date(endDateVal) : null;
    if(endDate) endDate.setHours(23,59,59,999); // Akhir hari tersebut

    // 2. Lakukan Filter Array
    return allData.filter(item => {
        // A. Filter Validasi Data Dasar
        if (!item.dateObj) return false;

        // B. Filter Rentang Waktu (Jika user mengisi tanggal)
        if (startDate && item.dateObj < startDate) return false;
        if (endDate && item.dateObj > endDate) return false;

        // C. Filter Jenis Bencana
        if (selectedBencana !== 'all' && item.bencana !== selectedBencana) return false;

        // D. Filter Kecamatan
        if (selectedKecamatan !== 'all' && item.kec !== selectedKecamatan) return false;

        return true; // Lolos semua filter
    });
}

        function processMapData(data) {
        // Hapus layer control lama jika ada
        if (mainLayerControl) mainLayerControl.remove();

        // Kosongkan layer group (sesuaikan: layerGroups atau allMarkersLayer)
        Object.values(layerGroups).forEach(lg => lg.clearLayers());
        // atau: allMarkersLayer.clearLayers();

        let overlayMaps = {};
        
        // Loop data
        data.forEach(item => {
            const bencana = item.bencana || "Tidak Terkategori";
            let chosenIcon; // Variabel ikon pilihan

            // Tentukan ikon berdasarkan status pipeline
            // Kita cek dari kondisi paling akhir (Monitoring)
            if (item.linkMonitoring) {
                // 3. Sudah Monitoring -> Hijau
                chosenIcon = iconMonitoring;
            } else if (item.linkSerahTerima) {
                // 2. Sudah Serah Terima (tapi belum monitoring) -> Kuning
                chosenIcon = iconSerahTerima;
            } else {
                // 1. Masih Terkaji (belum serah terima & belum monitoring) -> Merah
                chosenIcon = iconTerkaji;
            }

            // Cek data baru menggunakan item.dateObj
            const now = new Date();
            const itemDate = item.dateObj;
            let isNew = false;
            if (itemDate) {
                const diffHours = (now - itemDate) / (1000 * 60 * 60);
                isNew = diffHours <= 24;
            }

            // --- PERBAIKAN IKON MINIMALIS ---
            // 1. Buat SEMUA marker dengan ikon standar (chosenIcon)
            const marker = L.marker([item.lat, item.lng], { icon: chosenIcon });

            // 2. Jika marker baru, tambahkan kelas 'marker-new' ke elemen gambar SETELAH dibuat
            if (isNew) {
                // Tambahkan event 'add' untuk memastikan elemen marker sudah ada di DOM
                marker.on('add', function() {
                    // Dapatkan elemen HTML marker
                    const markerElement = this.getElement();
                    if (markerElement) {
                        // Tambahkan kelas 'marker-new' ke elemen utama marker
                        // CSS kita (.marker-new img) akan menargetkan gambar di dalamnya
                        markerElement.classList.add('marker-new');
                    }
                });
            }
            // --- AKHIR PERBAIKAN IKON MINIMALIS ---


            // --- PASTIKAN HOVER LISTENER DIHAPUS ---
            // marker.on('mouseover', function() { /* HAPUS */ });
            // marker.on('mouseout', function() { /* HAPUS */ });
            // --- AKHIR HAPUS HOVER ---


            // Listener klik tetap ada
            marker.on('click', () => {
                openSidebarWithData(item);
            });

            // Tambahkan ke layer group (sesuaikan)
            if (!layerGroups[bencana]) layerGroups[bencana] = L.layerGroup().addTo(map);
            if (layerGroups[bencana]) layerGroups[bencana].addLayer(marker);
            // atau: allMarkersLayer.addLayer(marker);

            
        }); // Akhir data.forEach

        // Buat kontrol HANYA untuk baseMaps
       /* mainLayerControl = L.control.layers(baseMaps, {}, { position: 'bottomright' }).addTo(map); */

	// 1. Lokasi Terkaji: Data yang BELUM punya linkSerahTerima DAN BELUM punya linkMonitoring
        // (Ini adalah tahap awal atau tahap disposisi)
        const totalTerkaji = data.filter(item => 
            !item.linkSerahTerima && !item.linkMonitoring
        ).length;

        // 2. Serah Terima Bantuan: Data yang SUDAH punya linkSerahTerima TAPI BELUM punya linkMonitoring
        // (Ini adalah tahap tengah)
        const totalBantuan = data.filter(item => 
            item.linkSerahTerima && !item.linkMonitoring
        ).length;

        // 3. Lokasi Monitoring: Data yang SUDAH punya linkMonitoring
        // (Ini adalah tahap akhir)
        const totalMonitoring = data.filter(item => 
            item.linkMonitoring
        ).length;

        // Update nilai di kartu
        if (statTerkajiEl) statTerkajiEl.innerText = totalTerkaji.toLocaleString('id-ID');
        if (statBantuanEl) statBantuanEl.innerText = totalBantuan.toLocaleString('id-ID');
        if (statMonitoringEl) statMonitoringEl.innerText = totalMonitoring.toLocaleString('id-ID');

	}
            
	function changePage(direction) {
        currentPage += direction;
    // Panggil ulang proses filter & render tabel
    // Kita gunakan applyFiltersAndProcess agar data tetap tersinkron dengan filter waktu
    	applyFiltersAndProcess(); 
	}

function updateDataTable(data) {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Tidak ada data untuk filter ini.</td></tr>`;
                // Update UI pagination jadi 0
                document.getElementById('page-indicator').innerText = '0';
                document.getElementById('prev-page-btn').disabled = true;
                document.getElementById('next-page-btn').disabled = true;
                return;
            }

            // 1. Urutkan Data (Terbaru di atas)
            const sortedData = [...data].sort((a, b) => {
                if (a.dateObj && b.dateObj) return b.dateObj - a.dateObj;
                else if (a.dateObj) return -1;
                else if (b.dateObj) return 1;
                return 0;
            });

            // 2. Hitung Pagination
            const totalPages = Math.ceil(sortedData.length / rowsPerPage);
            
            // Validasi currentPage agar tidak out of bound
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;

            // 3. Potong Data Sesuai Halaman (Slice)
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginatedData = sortedData.slice(startIndex, endIndex);

            // 4. Render Baris Tabel
            paginatedData.forEach(item => {
                let statusText = '', statusClass = '';

                if (item.linkMonitoring) {
                    statusText = 'Tuntas';
                    statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                } else if (item.linkSerahTerima) {
                    statusText = 'Tersalurkan';
                    statusClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300';
                } else {
                    statusText = 'Terkaji';
                    statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                }

                const tanggal = item.dateObj ? item.dateObj.toLocaleDateString('id-ID') : (item.tanggalWaktu || 'N/A');

                const row = `
                <tr class="hover:bg-background-light dark:hover:bg-background-dark transition-colors cursor-pointer" onclick='openMarkerByIdx("${item.idx}")'>
                    <td class="px-4 py-4 whitespace-nowrap font-medium">
                        ${item.nama || 'N/A'} <br> 
                        <span class="text-xs text-gray-500">${item.jalandusun || ''}</span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${statusText}</span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">${tanggal}</td>
                </tr>`;
                tbody.innerHTML += row;
            });

            // 5. Update UI Tombol Pagination
            document.getElementById('page-indicator').innerText = `${currentPage} / ${totalPages}`;
            document.getElementById('prev-page-btn').disabled = currentPage === 1;
            document.getElementById('next-page-btn').disabled = currentPage === totalPages;
        }
        
        function openMarkerByIdx(idx) {
// Cari data berdasarkan index uniknya
	const item = allData.find(d => d.idx == idx);
	    if (item) {
	    // 1. Pindahkan peta ke lokasi marker (Zoom)
	    map.flyTo([item.lat, item.lng], 16);
	    // 2. Buka sidebar dengan data item tersebut
	    openSidebarWithData(item);
	    } else {
	    console.warn("Item dengan idx tidak ditemukan:", idx); // Pesan jika data tidak ketemu
	    }
	}

        function updateKecamatanFilter() {
            const select = document.getElementById('kecamatan-filter');
            const sortedKecamatan = Array.from(allKecamatan).sort();
            sortedKecamatan.forEach(kec => {
                select.innerHTML += `<option value="${kec}">${kec}</option>`;
            });
        }

let activeDropdown = null; // Menyimpan ID dropdown yang sedang terbuka

// 1. FUNGSI RENDER OPSI CUSTOM (Gantikan populateFilterOptions lama dengan ini)
function populateFilterOptions() {
    if (!allData || allData.length === 0) return;

    // Ambil data unik
    const uniqueBencana = [...new Set(allData.map(d => d.bencana).filter(x => x))].sort();
    const uniqueKecamatan = [...new Set(allData.map(d => d.kec).filter(x => x))].sort();

    // Render List Bencana
    renderCustomOptions('bencana', uniqueBencana, 'Semua Jenis Bencana');
    
    // Render List Kecamatan
    renderCustomOptions('kecamatan', uniqueKecamatan, 'Semua Kecamatan');
}

// --- INISIALISASI KALENDER (FLATPICKR) ---
document.addEventListener("DOMContentLoaded", function() {
    
    // Konfigurasi Kalender
    const configDate = {
        dateFormat: "Y-m-d",     // Format data untuk sistem (2026-01-14)
        altInput: true,          // Aktifkan tampilan alternatif
        altFormat: "j F Y",      // Tampilan di layar: "14 Januari 2026"
        locale: "id",            // Bahasa Indonesia (Sen, Sel, Rab...)
        disableMobile: "true",   // Paksa pakai tema kita di HP (jangan pakai native HP)
        onChange: function(selectedDates, dateStr, instance) {
            // Langsung filter data begitu tanggal dipilih
            currentPage = 1;
            applyFiltersAndProcess();
        }
    };

    // Pasang ke Element HTML
    const fpStart = flatpickr("#filter-start-date", configDate);
    const fpEnd = flatpickr("#filter-end-date", configDate);
});

// Update fungsi Reset agar kalender juga bersih
function resetAllFilters() {
    // Bersihkan Kalender Flatpickr
    const startDateElem = document.querySelector("#filter-start-date");
    const endDateElem = document.querySelector("#filter-end-date");
    
    if(startDateElem && startDateElem._flatpickr) startDateElem._flatpickr.clear();
    if(endDateElem && endDateElem._flatpickr) endDateElem._flatpickr.clear();

    // Reset Dropdown & Input lain
    document.getElementById('filter-bencana').value = 'all';
    document.getElementById('filter-kecamatan').value = 'all';
    document.getElementById('label-dropdown-bencana').innerText = 'Semua Jenis Bencana';
    document.getElementById('label-dropdown-kecamatan').innerText = 'Semua Kecamatan';
    
    // Reset Proses
    currentPage = 1;
    applyFiltersAndProcess();
    populateFilterOptions();
}

// 2. FUNGSI GENERATE HTML OPSI
function renderCustomOptions(type, dataArray, defaultLabel) {
    const listContainer = document.getElementById(`list-${type}`);
    const currentVal = document.getElementById(`filter-${type}`).value;
    
    let html = '';

    // Tambahkan opsi "Semua"
    const isAllActive = currentVal === 'all' ? 'bg-primary/10 text-primary font-semibold' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800';
    
    html += `
    <div onclick="selectCustomOption('${type}', 'all', '${defaultLabel}')" 
         class="cursor-pointer px-3 py-2 rounded-lg text-sm transition-colors flex items-center justify-between ${isAllActive}">
        <span>${defaultLabel}</span>
        ${currentVal === 'all' ? '<span class="material-symbols-outlined text-sm">check</span>' : ''}
    </div>`;

    // Tambahkan opsi dari Data
    dataArray.forEach(item => {
        const isActive = currentVal === item ? 'bg-primary/10 text-primary font-semibold' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800';
        
        html += `
        <div onclick="selectCustomOption('${type}', '${item}', '${item}')" 
             class="cursor-pointer px-3 py-2 rounded-lg text-sm transition-colors flex items-center justify-between ${isActive} item-option">
            <span>${item}</span>
            ${currentVal === item ? '<span class="material-symbols-outlined text-sm">check</span>' : ''}
        </div>`;
    });

    listContainer.innerHTML = html;
}

// 3. FUNGSI BUKA/TUTUP DROPDOWN
function toggleDropdown(type) {
    const menu = document.getElementById(`menu-dropdown-${type}`);
    const arrow = document.getElementById(`arrow-${type}`);
    const btn = document.getElementById(`btn-dropdown-${type}`);

    // Jika dropdown ini sudah terbuka, tutup. Jika belum, buka.
    if (activeDropdown === type) {
        closeAllDropdowns();
    } else {
        closeAllDropdowns(); // Tutup yang lain dulu
        menu.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
        btn.classList.add('border-primary', 'ring-2', 'ring-primary/20'); // Highlight tombol
        activeDropdown = type;
        
        // Reset Search Input jika ada (khusus kecamatan)
        if(type === 'kecamatan') {
            const searchInput = document.getElementById('search-kecamatan-input');
            if(searchInput) {
                searchInput.value = '';
                filterKecamatanList(''); // Reset list
                searchInput.focus();
            }
        }
    }
}

function closeAllDropdowns() {
    ['bencana', 'kecamatan'].forEach(type => {
        const menu = document.getElementById(`menu-dropdown-${type}`);
        const arrow = document.getElementById(`arrow-${type}`);
        const btn = document.getElementById(`btn-dropdown-${type}`);
        
        if (menu) menu.classList.add('hidden');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
        if (btn) btn.classList.remove('border-primary', 'ring-2', 'ring-primary/20');
    });
    activeDropdown = null;
}

// 4. FUNGSI SAAT OPSI DIPILIH
function selectCustomOption(type, value, label) {
    // A. Update Nilai di Input Hidden (ini yang dibaca oleh getFilteredData)
    document.getElementById(`filter-${type}`).value = value;
    
    // B. Update Tampilan Tombol Trigger
    document.getElementById(`label-dropdown-${type}`).innerText = label;
    
    // C. Tutup Dropdown
    closeAllDropdowns();
    
    // D. Trigger Proses Filter Utama (Reset ke page 1)
    // Kita render ulang opsi agar tanda centang (checklist) berpindah
    // Tapi kita panggil populateFilterOptions setelah filter berjalan saja agar efisien
    
    currentPage = 1;
    applyFiltersAndProcess();
    
    // Render ulang opsi untuk update visual Checklist
    populateFilterOptions();
}

// 5. EVENT LISTENER: KLIK DI LUAR (CLOSE)
document.addEventListener('click', function(e) {
    // Cek apakah klik terjadi di dalam area dropdown manapun
    const isClickInside = e.target.closest('.relative.z-10') || e.target.closest('.relative.z-20');
    if (!isClickInside) {
        closeAllDropdowns();
    }
});

// 6. EVENT LISTENER: PENCARIAN KECAMATAN (BONUS)
const searchKecInput = document.getElementById('search-kecamatan-input');
if(searchKecInput) {
    searchKecInput.addEventListener('input', (e) => {
        filterKecamatanList(e.target.value.toLowerCase());
    });
}

function filterKecamatanList(query) {
    const items = document.querySelectorAll('#list-kecamatan .item-option');
    items.forEach(item => {
        const text = item.innerText.toLowerCase();
        if(text.includes(query)) {
            item.classList.remove('hidden');
        } else {
            item.classList.add('hidden');
        }
    });
}

// --- EVENT LISTENER UNTUK FILTER BARU ---
// Pasang ini di bagian bawah script, atau di dalam window.onload
const filterInputs = ['filter-start-date', 'filter-end-date', 'filter-bencana', 'filter-kecamatan'];
filterInputs.forEach(id => {
    const el = document.getElementById(id);
    if(el) {
        el.addEventListener('change', () => {
            currentPage = 1; // Reset ke halaman 1 setiap ganti filter
            applyFiltersAndProcess();
        });
    }
});


        // =================================================================
// GANTI FUNGSI LAMA ANDA DENGAN YANG INI SECARA KESELURUHAN
// =================================================================
function updateDashboardCharts(data) {
    
    // --- 1. Persiapan Data Kecamatan ---
    const kecamatanCounts = data.reduce((acc, item) => { const kecamatan = item.kecamatan || "N/A"; acc[kecamatan] = (acc[kecamatan] || 0) + 1; return acc; }, {});
    const kecLabels = Object.keys(kecamatanCounts);
    const kecData = Object.values(kecamatanCounts);

    // --- 2. Persiapan Data Kerusakan ---
    const kerusakanCounts = data.reduce((acc, item) => { const kerusakan = item.kerusakan || "N/A"; acc[kerusakan] = (acc[kerusakan] || 0) + 1; return acc; }, {});
    const colorMap = {
        'Rusak Ringan': 'rgba(75, 192, 192, 0.6)', // Greenish
        'Rusak Sedang': 'rgba(255, 206, 86, 0.6)', // Yellowish
        'Rusak Berat': 'rgba(255, 99, 132, 0.6)', // Reddish
        'N/A': 'rgba(201, 203, 207, 0.6)' // Abu-abu
    };
    const desiredOrder = ['Rusak Ringan', 'Rusak Sedang', 'Rusak Berat', 'N/A'];
    const sortedLabels = [];
    const sortedData = [];
    const sortedColors = [];
    desiredOrder.forEach(label => {
        if (kerusakanCounts.hasOwnProperty(label)) {
            sortedLabels.push(label);
            sortedData.push(kerusakanCounts[label]);
            sortedColors.push(colorMap[label] || colorMap['N/A']);
        }
    });

    // --- 3. Persiapan Data Konstruksi ---
    const konstruksiData = { 'Permanen': {}, 'Semi Permanen': {}, 'Non Permanen': {} };
    const kerusakanTypes = ['Rusak Ringan', 'Rusak Sedang', 'Rusak Berat'];
    for(const k in konstruksiData) { kerusakanTypes.forEach(t => konstruksiData[k][t] = 0); }
    data.forEach(item => { if (konstruksiData[item.konstruksi] && item.kerusakan) { konstruksiData[item.konstruksi][item.kerusakan]++; } });
    const konsLabels = ['Permanen', 'Semi Permanen', 'Non Permanen'];
    const konsDataRingan = [konstruksiData['Permanen']['Rusak Ringan'], konstruksiData['Semi Permanen']['Rusak Ringan'], konstruksiData['Non Permanen']['Rusak Ringan']];
    const konsDataSedang = [konstruksiData['Permanen']['Rusak Sedang'], konstruksiData['Semi Permanen']['Rusak Sedang'], konstruksiData['Non Permanen']['Rusak Sedang']];
    const konsDataBerat = [konstruksiData['Permanen']['Rusak Berat'], konstruksiData['Semi Permanen']['Rusak Berat'], konstruksiData['Non Permanen']['Rusak Berat']];


    // --- LOGIKA UTAMA: BUAT-ATAU-UPDATE ---

    // --- Chart 1: Kecamatan ---
    if (chartKecamatanInstance) {
        // Chart SUDAH ADA, update datanya
        chartKecamatanInstance.data.labels = kecLabels;
        chartKecamatanInstance.data.datasets[0].data = kecData;
        chartKecamatanInstance.update();
    } else {
        // Chart BELUM ADA, buat baru
        chartKecamatanInstance = new Chart(document.getElementById('chartKecamatan'), {
            type: 'bar',
            data: { labels: kecLabels, datasets: [{ label: 'Jumlah Kejadian', data: kecData, backgroundColor: 'rgba(54, 162, 235, 0.6)' }] },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
    }

    // --- Chart 2: Kerusakan ---
    if (chartKerusakanInstance) {
        // Chart SUDAH ADA, update datanya
        chartKerusakanInstance.data.labels = sortedLabels;
        chartKerusakanInstance.data.datasets[0].data = sortedData;
        chartKerusakanInstance.data.datasets[0].backgroundColor = sortedColors;
        chartKerusakanInstance.update();
    } else {
        // Chart BELUM ADA, buat baru
        chartKerusakanInstance = new Chart(document.getElementById('chartKerusakan'), {
            type: 'doughnut',
            data: { labels: sortedLabels, datasets: [{ data: sortedData, backgroundColor: sortedColors }] },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
    }

    // --- Chart 3: Konstruksi ---
    if (chartKonstruksiInstance) {
        // Chart SUDAH ADA, update datanya
        chartKonstruksiInstance.data.labels = konsLabels;
        chartKonstruksiInstance.data.datasets[0].data = konsDataRingan;
        chartKonstruksiInstance.data.datasets[1].data = konsDataSedang;
        chartKonstruksiInstance.data.datasets[2].data = konsDataBerat;
        chartKonstruksiInstance.update();
    } else {
        // Chart BELUM ADA, buat baru
        chartKonstruksiInstance = new Chart(document.getElementById('chartKonstruksi'), {
            type: 'bar',
            data: {
                labels: konsLabels,
                datasets: [
                    { label: 'Rusak Ringan', data: konsDataRingan, backgroundColor: 'rgba(75, 192, 192, 0.6)' },
                    { label: 'Rusak Sedang', data: konsDataSedang, backgroundColor: 'rgba(255, 206, 86, 0.6)' },
                    { label: 'Rusak Berat', data: konsDataBerat, backgroundColor: 'rgba(255, 99, 132, 0.6)' }
                ]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { x: { stacked: true }, y: { stacked: true } } }
        });
    }

    // --- 4. Update Tabel Bantuan (Ini sudah benar dari kode Anda) ---
    const bantuanLabels = [ "Semen", "Batu Bata", "Genteng", "Kalsiboard", "Kayu Balok", "Kayu Usuk", "Kayu Reng", "Besi ø 6 mm", "Besi ø 10 mm", "Terpal 3x4m", "Terpal 5x6m" ];
    const totalBantuan = {};
    bantuanLabels.forEach(label => totalBantuan[label] = 0);
    data.forEach(item => { if (item.bantuan && typeof item.bantuan === 'object') { for (const material in item.bantuan) { if(totalBantuan.hasOwnProperty(material)) { totalBantuan[material] += parseFloat(item.bantuan[material]) || 0; } } } });
    
    const tableContainer = document.getElementById('bantuan-table-container');
    const tableWrapper = tableContainer.querySelector('.bantuan-table-wrapper');
    const tableElement = tableWrapper ? tableWrapper.querySelector('.bantuan-table') : null;
    if (tableElement) {
        let tableContentHTML = '<thead><tr>';
        for (const material in totalBantuan) { tableContentHTML += `<th>${material}</th>`; }
        tableContentHTML += `</tr></thead><tbody><tr>`;
        for (const material in totalBantuan) { tableContentHTML += `<td>${totalBantuan[material]}</td>`; }
        tableContentHTML += `</tr></tbody>`;
        tableElement.innerHTML = tableContentHTML;
    } else {
        console.error("Elemen tabel '.bantuan-table' di dalam '.bantuan-table-wrapper' tidak ditemukan!");
    }
}
// =================================================================
// AKHIR DARI FUNGSI BARU
// =================================================================

/**
         * FUNGSI KRUSIAL 1: PARSER TANGGAL (Perbaikan v5 - Membaca Nama Bulan)
         * Tugas: Mengubah string 'DD NamaBulan YYYY ...' menjadi Objek Date
         */
        function parseIndonesianDate(dateString) {
            if (!dateString || typeof dateString !== 'string') {
                console.warn('Data tanggal kosong atau bukan string:', dateString);
                return null;
            }

            // --- PERBAIKAN: Buat mapping nama bulan ke angka (0-indexed) ---
            const bulanMap = {
                "januari": 0, "februari": 1, "maret": 2, "april": 3, "mei": 4, "juni": 5,
                "juli": 6, "agustus": 7, "september": 8, "oktober": 9, "november": 10, "desember": 11
            };
            // --- AKHIR PERBAIKAN ---

            // Bersihkan spasi berlebih di awal/akhir
            const trimmedDateString = dateString.trim();

            // Pisahkan berdasarkan spasi: ["09", "Oktober", "2025", "18:27"]
            const parts = trimmedDateString.split(' '); 
            
            if (parts.length < 3) {
                console.warn('Format tanggal salah (bukan "DD NamaBulan YYYY"):', trimmedDateString);
                return null; 
            }

            // 1. Parse Tanggal
            const day = parseInt(parts[0], 10);
            const monthName = parts[1].toLowerCase(); // "oktober"
            const year = parseInt(parts[2], 10);
            
            // Dapatkan angka bulan (0-11) dari mapping
            const month = bulanMap[monthName];

            if (month === undefined) {
                console.warn('Nama bulan tidak dikenali:', parts[1]);
                return null;
            }

            // 2. Parse Waktu (HH:mm:ss) - jika ada
            const timeString = parts[3] || '00:00:00'; // "18:27"
            const timeParts = timeString.split(':'); 
            
            const hour = parseInt(timeParts[0] || 0, 10);
            const minute = parseInt(timeParts[1] || 0, 10);
            const second = parseInt(timeParts[2] || 0, 10);

            // Cek jika angkanya tidak valid (NaN)
            if (isNaN(day) || isNaN(year) || isNaN(hour) || isNaN(minute) || isNaN(second)) {
                 console.warn('Gagal parse angka tanggal:', trimmedDateString);
                 return null;
            }

            // 3. Buat Objek Date
            // new Date(TAHUN, BULAN (0-11), HARI, JAM, MENIT, DETIK)
            const newDate = new Date(year, month, day, hour, minute, second);

            // 4. Validasi
            if (isNaN(newDate.getTime()) || newDate.getFullYear() !== year || newDate.getMonth() !== month || newDate.getDate() !== day) {
                 console.warn('Gagal parse tanggal (angka tidak valid):', trimmedDateString);
                 return null;
            }
            
            // console.log('BERHASIL Parse:', trimmedDateString, '->', newDate);
            return newDate;
        }

	function getWeatherInfo(code) {
  const weatherMap = {
    0: ["clear_day", "Cerah"],
    1: ["partly_cloudy_day", "Cerah Berawan"],
    2: ["cloud", "Berawan"],
    3: ["cloudy", "Mendung"],
    45: ["foggy", "Kabut"],
    48: ["foggy", "Kabut"],
    51: ["rainy_light", "Gerimis Ringan"],
    53: ["rainy", "Gerimis"],
    55: ["rainy", "Gerimis Lebat"],
    61: ["rainy_light", "Hujan Ringan"],
    63: ["rainy", "Hujan Sedang"],
    65: ["rainy_heavy", "Hujan Lebat"],
    80: ["rainy_light", "Hujan Ringan"],
    81: ["rainy", "Hujan Sedang"],
    82: ["rainy_heavy", "Hujan Lebat"],
    95: ["thunderstorm", "Badai Petir"],
    96: ["thunderstorm", "Badai Petir"],
    99: ["thunderstorm", "Badai Petir"],
  };
  return weatherMap[code] || ["thermostat", "N/A"];
}

/**
 * Memperbarui UI cuaca di sidebar
 * @param {object} data - Data JSON dari Open-Meteo
 */
function updateWeatherUI(data) {
  try {
    const current = data.current_weather;
    const daily = data.daily;
    
    // Mendapatkan ikon dan deskripsi
    const [iconName, description] = getWeatherInfo(current.weathercode);

    // Update Elemen DOM
    document.getElementById('weather-icon').innerText = iconName;
    document.getElementById('weather-temp').innerText = `${Math.round(current.temperature)}°C`;
    document.getElementById('weather-desc').innerText = description;
    
    // Update Min/Max (mengambil hari pertama dari data harian)
    document.getElementById('weather-range').innerText = 
      `Tertinggi: ${Math.round(daily.temperature_2m_max[0])}° / Terendah: ${Math.round(daily.temperature_2m_min[0])}°`;

  } catch (e) {
    console.error("Gagal memperbarui UI cuaca:", e);
    document.getElementById('weather-desc').innerText = "Gagal memuat";
  }
}

/**
 * Mengambil data cuaca dari Open-Meteo
 */
async function fetchWeather() {
  // Menggunakan Lat/Lng dari config peta Anda [cite: 371]
  const lat = -8.17;
  const lon = 113.70;
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia/Jakarta`;

  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const data = await response.json();
    updateWeatherUI(data);
  } catch (error) {
    console.error("Gagal mengambil data cuaca:", error);
    document.getElementById('weather-desc').innerText = "Gagal mengambil data";
    document.getElementById('weather-icon').innerText = "error";
  }
}

/**
         * FUNGSI KRUSIAL 2: EKSEKUTOR (fetchData)
         * Tugas: Mengambil data DAN memanggil parser untuk setiap baris data
         */
        function fetchData() {
            fetch(DATA_URL)
                .then(r => r.json())
                .then(rawData => {
                    /* loader.style.display = 'none'; */
		    
		    loader.style.opacity = '0';
                    // 2. Setelah animasi selesai (500ms), sembunyikan total
                    setTimeout(() => {
                        loader.style.display = 'none';
                    }, 500); // Samakan dengan durasi transisi CSS
                    // --- AKHIR KODE PENGGANTI ---

                    // --- INI BAGIAN PENTING UNTUK MENCIPTAKAN .dateObj ---
                    const processedData = rawData.map((item, index) => {
                        item.dateObj = parseIndonesianDate(item.tanggalWaktu);
			item.idx = index;
                        return item;
                    });
                    // --- AKHIR BAGIAN PENTING ---

                    if (allData.length > 0 && processedData.length > allData.length) {
                        const newData = processedData[processedData.length - 1];
			map.flyTo([newData.lat, newData.lng], 15);
                        showNotification(`Laporan baru masuk: ${newData.nama}`);
			const audio = document.getElementById('notification-sound');
                        if (audio) { // Pastikan elemen audio ada
                            audio.play().catch(error => {
                                // Browser modern kadang memblokir auto-play
                                // Beri tahu user jika suara gagal diputar
                                console.warn("Suara notifikasi gagal diputar:", error);
                                // Anda bisa tambahkan notifikasi visual tambahan di sini jika perlu
                            });
                        }
                    }
                    
                    allData = processedData;
		    populateFilterOptions(); 
		    renderReportCharts();
                    applyFiltersAndProcess();
		    adjustTableHeight();
		    map.invalidateSize(); 
                })
                .catch(error => {
                    console.error('Gagal mengambil data:', error);
                    loader.style.display = 'none';
                    showNotification('Gagal memuat data. Cek konsol.');
                });
        }

        function showNotification(message) {
            notification.innerText = message;
            notification.style.display = 'block';
            notification.style.opacity = '1';
            notification.style.top = '6rem'; 
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.top = '4rem';
                setTimeout(() => { notification.style.display = 'none'; }, 500);
            }, 5000);
        }

	function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64Data = reader.result.split(',')[1];
                    resolve({
                        fileName: file.name,
                        fileType: file.type,
                        fileData: base64Data 
                    });
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }

async function handleSidebarUpload(fileType, reportIndex) {
            
            const UPLOAD_URL = DATA_URL;
            let fileInput;
            let uploadButton;
            let columnName;
            
            // --- IDENTIFIKASI ELEMEN ---
            if (fileType === 'disposisi') {
                fileInput = document.getElementById('file-disposisi-input');
                uploadButton = document.getElementById('upload-disposisi-btn');
                columnName = 'Link Disposisi'; 
            } else if (fileType === 'serahTerima') {
                fileInput = document.getElementById('file-serahTerima-input'); 
                uploadButton = document.getElementById('upload-serahTerima-btn');
                columnName = 'Link Serah Terima'; 
            } else if (fileType === 'monitoring') {
                fileInput = document.getElementById('file-monitoring-input');
                uploadButton = document.getElementById('upload-monitoring-btn');
                columnName = 'Link Monitoring'; 
            } else if (fileType === 'dokumentasi') {
                fileInput = document.getElementById('file-dokumentasi-input');
                uploadButton = null; 
                columnName = 'Link Dokumentasi'; 
            } else {
                showNotification('Tipe file upload tidak dikenal.');
                return;
            }

            if (!fileInput || fileInput.files.length === 0) {
                showNotification('Gagal: Silakan pilih setidaknya satu file terlebih dahulu.');
                return;
            }

            const filesToUpload = fileInput.files;
            const reportData = allData.find(item => item.idx == reportIndex);

            if (!reportData) {
                showNotification('Gagal: Data laporan tidak ditemukan.');
                return;
            }

            // --- UI LOADING STATE (PERBAIKAN LOKASI) ---
            let originalContent = '';
            let addPhotoBox = null;

            if (fileType === 'dokumentasi') {
                // CARI KOTAK TAMBAH BERDASARKAN ID BARU
                addPhotoBox = document.getElementById('add-photo-btn');
                
                if(addPhotoBox) {
                    originalContent = addPhotoBox.innerHTML;
                    
                    // Ganti isi kotak tersebut dengan spinner
                    addPhotoBox.innerHTML = `
                        <div class="flex flex-col items-center justify-center w-full h-full animate-pulse">
                            <span class="material-symbols-outlined animate-spin text-3xl text-primary">progress_activity</span>
                            <span class="text-[10px] text-gray-500 font-medium mt-2">Uploading...</span>
                            <span class="text-[10px] text-gray-400 font-bold" id="upload-progress-text">0/${filesToUpload.length}</span>
                        </div>
                    `;
                    addPhotoBox.onclick = null; // Matikan klik
                    addPhotoBox.classList.add('cursor-not-allowed', 'bg-gray-100', 'dark:bg-gray-800');
                }
            } else if (uploadButton) {
                uploadButton.disabled = true;
                uploadButton.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span> Mengupload...';
            }
            
            let filesUploaded = 0;

            try {
                // --- LOOP UPLOAD ---
                for (const file of filesToUpload) {
                    const fileBase64 = await readFileAsBase64(file);
                    filesUploaded++;
                    
                    if (fileType === 'dokumentasi' && document.getElementById('upload-progress-text')) {
                        document.getElementById('upload-progress-text').innerText = `${filesUploaded}/${filesToUpload.length}`;
                    } else if (uploadButton) {
                         uploadButton.innerHTML = `<span class="material-symbols-outlined animate-spin">progress_activity</span> (${filesUploaded}/${filesToUpload.length})...`;
                    }
                    
                    const payload = {
                        mode: 'update', 
                        file: fileBase64,
                        laporanId: reportData.timestamp,
                        columnName: columnName,
                        folderData: {
                            jenisBencana: reportData.bencana,
                            alamatDesa: reportData.desakelurahan,
                            alamatKecamatan: reportData.kec,
                            namaKK: reportData.nama
                        },
                        fileIndex: filesUploaded, 
                        tanggalLaporan: reportData.tanggalWaktu ? reportData.tanggalWaktu.split(' ').slice(0, 3).join(' ') : ""
                    };

                    await fetch(UPLOAD_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify(payload),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    });
                }

                showNotification(`Sukses! ${filesToUpload.length} file berhasil diupload.`);
                
                closeSidebar(); 
                if(fetchInterval) clearInterval(fetchInterval);
                fetchData(); 
                fetchInterval = setInterval(fetchData, 5000);

            } catch (error) {
                console.error('Gagal upload file:', error);
                showNotification(`Gagal: ${error.message}`);
                
                // Restore UI jika gagal
                if (fileType === 'dokumentasi' && addPhotoBox) {
                    addPhotoBox.innerHTML = originalContent;
                    addPhotoBox.onclick = function() { document.getElementById('file-dokumentasi-input').click(); };
                    addPhotoBox.classList.remove('cursor-not-allowed', 'bg-gray-100', 'dark:bg-gray-800');
                } else if (uploadButton) {
                    uploadButton.disabled = false;
                    uploadButton.innerHTML = '<span class="material-symbols-outlined">upload_file</span> Upload';
                }
            }
        }

	function formatRupiah(angka) {
    if (!angka || isNaN(parseFloat(angka)) || parseFloat(angka) === 0) {
        return "Rp 0";
    }
    let number = parseFloat(String(angka).replace(/[^0-9]/g, ''));
    return "Rp " + new Intl.NumberFormat('id-ID', { 
        minimumFractionDigits: 0,
        maximumFractionDigits: 0 
    }).format(number);
}


/**
         * Fungsi Pembantu untuk Merender Bagian Dokumen (Support Multi-File)
         */
        function renderDokumenSection(judul, linkString, tipeInput, idx) {
            // 1. Cek dan Pecah Link berdasarkan koma
            let linksHtml = '';
            if (linkString && linkString !== '-' && linkString.trim() !== '') {
                const urls = linkString.split(',').map(u => u.trim()).filter(u => u);
                
                if (urls.length > 0) {
                    linksHtml += '<div class="flex flex-wrap gap-2 mb-3">';
                    urls.forEach((url, i) => {
                        linksHtml += `
                            <a href="${url}" target="_blank" class="inline-flex items-center gap-1.5 px-3 py-2 bg-blue-50 dark:bg-blue-900/40 text-blue-700 dark:text-blue-200 border border-blue-200 dark:border-blue-800 rounded-lg text-xs font-semibold hover:bg-blue-100 dark:hover:bg-blue-800 transition-colors" title="Buka File ke-${i+1}">
                                <span class="material-symbols-outlined text-sm">description</span>
                                File ${i + 1}
                            </a>
                        `;
                    });
                    linksHtml += '</div>';
                }
            }

            // 2. Tampilkan Form Upload (Selalu tampil agar bisa tambah file kapan saja)
            // Tombol ini mendukung upload BANYAK file sekaligus (multiple)
            const uploadHtml = `
                <div class="flex items-center gap-2">
                    <input type="file" id="file-${tipeInput}-input" accept=".pdf,.jpg,.jpeg,.png" multiple
                           class="block w-full flex-1 text-xs text-gray-500 dark:text-gray-400
                                  file:mr-2 file:py-1.5 file:px-3 file:rounded-md file:border-0 
                                  file:text-xs file:font-medium
                                  file:bg-gray-100 file:text-gray-700 
                                  dark:file:bg-gray-700 dark:file:text-gray-300
                                  hover:file:bg-gray-200 dark:hover:file:bg-gray-600
                                  cursor-pointer">
                    <button id="upload-${tipeInput}-btn" 
                            onclick="handleSidebarUpload('${tipeInput}', '${idx}')"
                            class="flex-shrink-0 flex items-center justify-center gap-1 bg-primary hover:bg-blue-600 text-white 
                                   text-xs font-medium py-1.5 px-3 rounded-md transition-colors h-8
                                   disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="material-symbols-outlined text-sm">cloud_upload</span>
                        Upload
                    </button>
                </div>
            `;

            return `
                <div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-100 dark:border-gray-700">
                    <p class="text-xs font-bold uppercase text-gray-500 dark:text-gray-400 mb-2 tracking-wide">${judul}</p>
                    ${linksHtml}
                    ${uploadHtml}
                </div>
            `;
        }

	/**
 * Fungsi Mengubah Link Drive "View" menjadi Link "Thumbnail/Gambar"
 */
function getDriveImgUrl(url) {
            if (!url) return "";

            let fileId = "";

            // 1. Cek Pola "/d/ID" (Contoh: drive.google.com/file/d/123.../view)
            const matchSlash = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (matchSlash && matchSlash[1]) {
                fileId = matchSlash[1];
            } 
            // 2. Cek Pola "id=ID" (Contoh: drive.google.com/open?id=123...)
            else {
                const matchParam = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (matchParam && matchParam[1]) {
                    fileId = matchParam[1];
                }
            }

            // Jika ID ditemukan, gunakan endpoint thumbnail
            if (fileId) {
                // sz=s1000 artinya: Minta gambar ukuran 1000px (Cukup tajam & Anti-Blokir)
                return `https://drive.google.com/thumbnail?id=${fileId}&sz=s1000`;
            }

            // Jika bukan link drive, kembalikan URL asli (mungkin link direct)
            return url;
        }


/**
         * ==================================================================
         * 1. FUNGSI PEMBANTU LIGHTBOX (PREVIEW GAMBAR)
         * ==================================================================
         */
        function openImagePreview(originalUrl) {
            const modal = document.getElementById('image-preview-modal');
            const img = document.getElementById('preview-image-element');
            
            if (!originalUrl) return;

            // Ambil URL gambar dari fungsi helper di atas
            let displaySrc = getDriveImgUrl(originalUrl);
            
            // Trik: Ubah ukuran jadi s3000 (sangat besar) khusus untuk preview layar penuh
            if (displaySrc.includes("google.com/thumbnail")) {
                displaySrc = displaySrc.replace("sz=s1000", "sz=s3000");
            }

            // Reset kondisi awal
            img.src = ""; 
            img.classList.remove('scale-100');
            img.classList.add('scale-95');

            // Tampilkan Modal
            modal.classList.remove('hidden');
            
            // Set Source Gambar
            img.src = displaySrc;
            
            // Animasi zoom saat gambar selesai dimuat
            img.onload = () => {
                img.classList.remove('scale-95');
                img.classList.add('scale-100');
            };
        }

        function closeImagePreview() {
            const modal = document.getElementById('image-preview-modal');
            const img = document.getElementById('preview-image-element');
            
            // Efek zoom out
            img.classList.remove('scale-100');
            img.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                img.src = ''; // Bersihkan memori
            }, 200);
        }

        // Tutup dengan tombol ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                closeImagePreview();
            }
        });


        /**
         * ==================================================================
         * 2. FUNGSI UTAMA: OPEN SIDEBAR (FULL CODE)
         * ==================================================================
         */
        function openSidebarWithData(data) {
            const content = document.getElementById('sidebar-content');
            const sidebarTitle = document.getElementById('sidebar-title');
            const routeButton = document.getElementById('route-button-link');
            const downloadButton = document.getElementById('download-laporan-btn');

            // --- LOGIKA PENENTUAN DESA / KELURAHAN ---
            const kecamatanKota = ['kaliwates', 'patrang', 'sumbersari'];
            const kecRaw = (data.kec || '').toLowerCase().trim();
            const jenisWilayah = kecamatanKota.includes(kecRaw) ? 'Kelurahan' : 'Desa';
            // ------------------------------------------

            // --- BAGIAN BANTUAN ---
            let bantuanHtml = '';
            if (data.bantuan && typeof data.bantuan === 'object') {
                let adaBantuan = false;
                let bantuanContent = '<div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">';
                for (const item in data.bantuan) {
                    const jumlah = parseFloat(data.bantuan[item]) || 0;
                    if (jumlah > 0) {
                        adaBantuan = true;
                        bantuanContent += `<div class="flex justify-between border-b border-dashed border-gray-200 dark:border-gray-700 pb-1"><span>${item}</span> <span class="font-semibold">${jumlah}</span></div>`;
                    }
                }
                bantuanContent += '</div>';
                if (adaBantuan) {
                    bantuanHtml = `<div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg border border-yellow-100 dark:border-yellow-800/30 mb-4"><h4 class="text-sm font-bold text-yellow-800 dark:text-yellow-500 mb-3 flex items-center gap-2"><span class="material-symbols-outlined text-base">inventory_2</span> Bantuan Stimulan</h4>${bantuanContent}</div>`;
                }
            }

            // --- BAGIAN GALERI FOTO (DENGAN PREVIEW & TOMBOL TAMBAH) ---
            let galleryHtml = '';
            
            // Ambil array foto yang valid
            const photoList = (data.photos || []).filter(url => url && url.trim() !== "");
            const photoCount = photoList.length;
            const MAX_PHOTOS = 8; 

            galleryHtml += `
            <div class="mt-6">
                <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2 mb-4">
                    <h4 class="text-base font-bold flex items-center gap-2">
                        <span class="material-symbols-outlined">photo_library</span> 
                        Dokumentasi Lapangan
                    </h4>
                    <span class="text-xs font-medium px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400">
                        ${photoCount} / ${MAX_PHOTOS}
                    </span>
                </div>
                
                <div class="sidebar-gallery grid grid-cols-3 gap-2">`;
            
            // Loop Foto: Gunakan DIV dan ONCLICK untuk Preview
            photoList.forEach((photoUrl, index) => {
                const displaySrc = getDriveImgUrl(photoUrl); // Thumbnail kecil untuk grid
                
                galleryHtml += `
                <div onclick="openImagePreview('${photoUrl}')" class="group relative aspect-square bg-gray-100 dark:bg-gray-800 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 block shadow-sm cursor-pointer hover:ring-2 hover:ring-primary/50 transition-all">
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-300 dark:text-gray-600 z-0">
                        <span class="material-symbols-outlined text-3xl">image</span>
                    </div>
                    
                    <img src="${displaySrc}" class="relative z-10 w-full h-full object-cover transition-all duration-500 ease-in-out group-hover:scale-110 opacity-0" 
                         alt="Foto ${index + 1}" loading="lazy" 
                         onload="this.classList.remove('opacity-0')" 
                         onerror="this.style.display='none'">
                    
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors z-20 pointer-events-none"></div>
                    
                    <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-30 pointer-events-none">
                        <span class="material-symbols-outlined text-white drop-shadow-md text-3xl">visibility</span>
                    </div>
                </div>`; 
            });

            // Tombol "Tambah Foto" (Hanya jika < 8)
            if (photoCount < MAX_PHOTOS) {
                galleryHtml += `
                <div id="add-photo-btn" onclick="document.getElementById('file-dokumentasi-input').click()" 
                     class="aspect-square bg-gray-50 dark:bg-gray-800/50 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 flex flex-col items-center justify-center cursor-pointer hover:border-primary hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all group">
                    <span class="material-symbols-outlined text-gray-400 group-hover:text-primary transition-colors text-3xl">add_a_photo</span>
                    <span class="text-[10px] text-gray-500 group-hover:text-primary font-medium mt-1">Tambah</span>
                </div>`;
            }

            // Input Hidden
            galleryHtml += `
                </div>
                <input type="file" id="file-dokumentasi-input" accept="image/*" multiple 
                       class="hidden" 
                       onchange="handleSidebarUpload('dokumentasi', '${data.idx}')">
            </div>`;


            // --- SETUP TOMBOL & HEADER ---
            const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${data.lat},${data.lng}`; 
            sidebarTitle.innerText = data.nama || 'Detail Laporan';
            
            const tanggalAsesmen = data.dateObj 
                ? data.dateObj.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) 
                : (data.tanggalWaktu || 'Tidak ada data');

            // --- RENDER KONTEN UTAMA (HTML) ---
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-white dark:bg-card-dark rounded-lg">
                        <div class="flex items-start gap-3 mb-4">
                            <div class="bg-primary/10 text-primary p-2 rounded-full">
                                <span class="material-symbols-outlined text-xl">location_on</span>
                            </div>
                            <div>
                                <h4 class="text-base font-bold">${data.jalandusun || 'Dusun Tidak Diketahui'}</h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    ${jenisWilayah} ${data.desakelurahan}, Kec. ${data.kec}
                                </p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-xs text-gray-400">Jenis Bencana</p>
                                <p class="font-medium">${data.bencana||'-'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400">Tanggal Asesmen</p>
                                <p class="font-medium">${tanggalAsesmen}</p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-xs text-gray-400">Hasil Pengkajian</p>
                                <p class="font-medium leading-relaxed">${data.pengkajian||'-'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-red-50 dark:bg-red-900/10 p-4 rounded-lg border border-red-100 dark:border-red-900/30">
                         <h4 class="text-sm font-bold text-red-700 dark:text-red-400 mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-base">house_siding</span> Kerusakan & Kerugian
                         </h4>
                         <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span>Tingkat Kerusakan:</span> <span class="font-bold px-2 py-0.5 rounded bg-white dark:bg-black/20">${data.kerusakan || '-'}</span></div>
                            <div class="flex justify-between"><span>Bagian Rusak:</span> <span class="font-medium text-right">${data.bagianRusak || '-'}</span></div>
                            <div class="border-t border-red-200 dark:border-red-800 my-2 pt-2"></div>
                            <div class="flex justify-between"><span>Taksiran Kerusakan:</span> <span class="font-bold">${formatRupiah(data.nilaiKerusakan)}</span></div>
                            <div class="flex justify-between"><span>Taksiran Kerugian:</span> <span class="font-bold">${formatRupiah(data.nilaiKerugian)}</span></div>
                         </div>
                    </div>
                    
                    ${bantuanHtml}
                    
                    <div>
                        <h4 class="text-base font-bold border-b border-gray-200 dark:border-gray-700 pb-2 mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined">folder_open</span> Dokumen Administrasi
                        </h4>
                        <div class="space-y-3">
                            ${renderDokumenSection('Surat Disposisi', data.linkDisposisi, 'disposisi', data.idx)}
                            ${renderDokumenSection('Berita Acara Serah Terima', data.linkSerahTerima, 'serahTerima', data.idx)}
                            ${renderDokumenSection('Laporan Monitoring', data.linkMonitoring, 'monitoring', data.idx)}
                        </div>
                    </div>
                    
                    ${galleryHtml}
                </div>
            `;

            routeButton.href = googleMapsUrl; 
            if (data.linkDokumen) { 
                downloadButton.href = data.linkDokumen; 
                
                // Gunakan class Tailwind untuk memunculkan (Flex agar icon & teks tengah)
                downloadButton.classList.remove('hidden'); 
                downloadButton.classList.add('flex'); 
            } else { 
                // Sembunyikan
                downloadButton.classList.add('hidden');
                downloadButton.classList.remove('flex');
            }
            
            sidebar.classList.remove('translate-x-full'); 
            sidebar.classList.add('translate-x-0');
        }

        function closeSidebar() {
            sidebar.classList.add('translate-x-full');
            sidebar.classList.remove('translate-x-0');
        }

	/**
         * FUNGSI: Menyesuaikan tinggi tabel (Versi Debug)
         */
        /**
         * FUNGSI: Menyesuaikan tinggi PETA dan TABEL agar pas di layar (Revisi)
         */
        function adjustTableHeight() {
    // Definisi Elemen
    const mainArea = document.querySelector('main'); 
    const header = mainArea ? mainArea.querySelector('header') : null;
    const contentScroller = mainArea ? mainArea.querySelector('div.overflow-y-auto') : null; // Container scroll utama
    
    const dashboardView = document.getElementById('dashboard-view');
    const summaryBox = document.getElementById('summary-box');
    const mapCard = document.getElementById('map-card');
    const tableCard = document.getElementById('table-card');
    const tableHeader = document.getElementById('table-header');
    const tableScroller = document.getElementById('table-scroll-container');

    // 1. CEK PENTING: Jika sedang di REPORTS view, jangan kunci scroll!
    if (dashboardView && dashboardView.classList.contains('hidden')) {
        if(contentScroller) {
            contentScroller.style.overflowY = 'auto'; // Pastikan bisa scroll
        }
        return; // Hentikan fungsi, biarkan layout bebas
    }

    // 2. Logic Dashboard (Hanya jalan di layar besar XL)
    if (window.innerWidth >= 1280 && mainArea && header && contentScroller && summaryBox && mapCard && tableCard && tableHeader && tableScroller) {
        try {
            const mainHeight = mainArea.offsetHeight;
            const headerHeight = header.offsetHeight;
            const contentPaddingY = 48; // p-6 = 24px atas + 24px bawah
            const summaryHeight = summaryBox.offsetHeight;
            const gridGap = 24; // gap-6

            // Hitung sisa ruang untuk Peta & Tabel
            const availableHeight = mainHeight - headerHeight - contentPaddingY - summaryHeight - gridGap;
            const targetGridRowHeight = Math.max(availableHeight, 300); // Minimal 300px

            // Terapkan Tinggi
            mapCard.style.height = targetGridRowHeight + 'px';
            tableCard.style.height = targetGridRowHeight + 'px';

            // Hitung scroller dalam tabel
            const tableHeaderHeight = tableHeader.offsetHeight;
            const scrollerMaxHeight = targetGridRowHeight - tableHeaderHeight - 2; // -2 untuk border

            tableScroller.style.maxHeight = scrollerMaxHeight + 'px';
            tableScroller.style.height = scrollerMaxHeight + 'px';

            // Kunci scroll utama agar dashboard tampil "App-like" (tanpa scroll luar)
            contentScroller.style.overflowY = 'hidden';

        } catch (e) {
            console.error("Error calculating heights:", e);
            // Fallback jika error
            if(contentScroller) contentScroller.style.overflowY = 'auto';
        }

    } else if (contentScroller) {
        // Di layar kecil (Mobile/Tablet), biarkan scroll normal
        contentScroller.style.overflowY = 'auto';
        if(mapCard) mapCard.style.height = '';
        if(tableCard) tableCard.style.height = '';
        if(tableScroller) {
            tableScroller.style.maxHeight = '';
            tableScroller.style.height = '';
        }
    }
}

        fetchData(); 
        fetchInterval = setInterval(fetchData, 5000);
	fetchWeather();
	setInterval(fetchWeather, 600000);
	window.addEventListener('resize', adjustTableHeight); 


        // =============================================
        // SKRIP DARI KODE REFERENSI (Dark Mode & UI)
        // =============================================

// --- Dark Mode Toggle (UPDATE BAGIAN INI) ---
    const themeToggle = document.getElementById('theme-toggle');
    const html = document.documentElement;

    themeToggle.addEventListener('click', () => {
        // 1. Toggle Class HTML (CSS)
        html.classList.toggle('dark');
        const isDark = html.classList.contains('dark');

        // 2. Update Layer Peta (Logic Lama)
        if (isDark) {
            if (map.hasLayer(osm)) map.removeLayer(osm);
            if (!map.hasLayer(dark)) dark.addTo(map);
        } else {
            if (map.hasLayer(dark)) map.removeLayer(dark);
            if (!map.hasLayer(osm)) osm.addTo(map);
        }

        // 3. UPDATE WARNA CHART SECARA INSTAN (LOGIC BARU)
        // Tentukan warna baru berdasarkan mode
        const newTextColor = isDark ? '#EAEAEA' : '#333';
        const newGridColor = isDark ? '#404040' : '#E5E7EB';

        // Ambil semua chart yang sedang aktif dari variabel global
        Object.values(reportChartInstances).forEach(chart => {
            
            // A. Update Warna Legend (Judul Label)
            if (chart.options.plugins && chart.options.plugins.legend) {
                chart.options.plugins.legend.labels.color = newTextColor;
            }

            // B. Update Warna Sumbu (X, Y, atau R untuk Polar)
            if (chart.options.scales) {
                ['x', 'y', 'r'].forEach(axis => {
                    if (chart.options.scales[axis]) {
                        // Ganti warna angka/tulisan
                        if (chart.options.scales[axis].ticks) {
                            chart.options.scales[axis].ticks.color = newTextColor;
                            // Khusus Polar Area: background tick transparan
                            if(axis === 'r') chart.options.scales[axis].ticks.backdropColor = 'transparent';
                        }
                        // Ganti warna garis grid
                        if (chart.options.scales[axis].grid) {
                            chart.options.scales[axis].grid.color = newGridColor;
                        }
                    }
                });
            }

            // C. Render ulang chart SECARA INSTAN (mode: 'none' artinya tanpa animasi)
            chart.update('none'); 
        });
    });

        // --- Atur Layer Peta Awal (Opsional tapi bagus) ---
        // Panggil ini sekali setelah peta diinisialisasi, sebelum fetchData
        function setInitialMapLayer() {
             if (html.classList.contains('dark')) {
                 if (map.hasLayer(osm)) map.removeLayer(osm); // Hapus default OSM jika mulai dark
                 dark.addTo(map);
             } else {
                 // osm sudah ditambahkan saat inisialisasi, jadi tidak perlu `osm.addTo(map);` lagi
             }
        }
        // Panggil fungsi ini SETELAH inisialisasi peta dan SEBELUM fetchData() pertama kali
        // Contoh:
        // ... (kode inisialisasi map, baseMaps, dll.) ...
        setInitialMapLayer(); // <-- PANGGIL DI SINI
        fetchData();
        // ...

        const hamburgerBtn = document.getElementById('hamburger-btn');
        const filterSidebar = document.getElementById('filter-sidebar');
        const filterOverlay = document.getElementById('filter-overlay');
        const closeFilterBtn = document.getElementById('close-filter-btn');

        hamburgerBtn.addEventListener('click', () => {
            filterSidebar.classList.remove('-translate-x-full');
            filterSidebar.classList.add('translate-x-0');
            filterOverlay.classList.remove('hidden');
        });

        function closeFilterSidebar() {
            filterSidebar.classList.add('-translate-x-full');
            filterSidebar.classList.remove('translate-x-0');
            filterOverlay.classList.add('hidden');
        }

        closeFilterBtn.addEventListener('click', closeFilterSidebar);
        filterOverlay.addEventListener('click', closeFilterSidebar);

        // =============================================
        // SKRIP UNTUK FITUR BARU (Filter)
        // =============================================

        const timeFilterButtons = document.querySelectorAll('#time-filter-buttons .filter-btn');
        timeFilterButtons.forEach(button => {
            button.addEventListener('click', () => {
                timeFilterButtons.forEach(btn => {
                    btn.classList.remove('bg-primary/10', 'text-primary', 'font-medium');
                });
                button.classList.add('bg-primary/10', 'text-primary', 'font-medium');
                currentTimeFilter = button.getAttribute('data-filter');
		currentPage = 1;
                applyFiltersAndProcess();
            });
        });

	// ==========================================
    // 1. LOGIKA SWITCH VIEW (DASHBOARD <-> REPORTS)
    // ==========================================
	function switchView(viewName) {
        const dashboardView = document.getElementById('dashboard-view');
        const reportsView = document.getElementById('reports-view');
        
        // ELEMENT BARU
        const navPill = document.getElementById('nav-pill');
        const navDashboard = document.getElementById('nav-dashboard');
        const navReports = document.getElementById('nav-reports');
        const floatBtn = document.getElementById('open-form-btn'); 

        // Style Text (Hanya warna, karena background diurus oleh Pill)
        const textActive = [
            'text-primary', 
            'hover:text-primary', 
            'dark:hover:text-primary'
        ];
        const textInactive = [
            'text-gray-500', 
            'dark:text-gray-400', 
            'hover:text-gray-900',    
            'dark:hover:text-gray-100'
        ];

        // Class Animasi View
        const animVisible = ['opacity-100', 'scale-100']; 
        const animHidden = ['opacity-0', 'scale-95'];
        const btnVisible = ['opacity-100', 'scale-100'];
        const btnHidden = ['opacity-0', 'scale-0'];

        if (viewName === 'dashboard') {
            // 1. ANIMASI NAVIGASI (SLIDING PILL)
            // Geser Pill ke Kiri (Hapus translate-x-full, tambah translate-x-0)
            navPill.classList.remove('translate-x-full');
            navPill.classList.add('translate-x-0');

            // Update Warna Teks
            navDashboard.classList.add(...textActive);
            navDashboard.classList.remove(...textInactive);
            navReports.classList.remove(...textActive);
            navReports.classList.add(...textInactive);

            // 2. ANIMASI KELUAR (Reports)
            reportsView.classList.remove(...animVisible);
            reportsView.classList.add(...animHidden);

            setTimeout(() => {
                // SWAP
                reportsView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                void dashboardView.offsetWidth; 

                // ANIMASI MASUK
                dashboardView.classList.remove(...animHidden);
                dashboardView.classList.add(...animVisible);

                // BUTTON POP UP
                if(floatBtn) {
                    floatBtn.classList.remove('hidden'); 
                    void floatBtn.offsetWidth; 
                    floatBtn.classList.remove(...btnHidden); 
                    floatBtn.classList.add(...btnVisible);   
                }

                if (typeof adjustTableHeight === 'function') adjustTableHeight();
                if (map) map.invalidateSize(); 

            }, 300);

        } else if (viewName === 'reports') {
            // 1. ANIMASI NAVIGASI (SLIDING PILL)
            // Geser Pill ke Kanan
            navPill.classList.remove('translate-x-0');
            navPill.classList.add('translate-x-full');

            // Update Warna Teks
            navDashboard.classList.remove(...textActive);
            navDashboard.classList.add(...textInactive);
            navReports.classList.add(...textActive);
            navReports.classList.remove(...textInactive);

            // 2. ANIMASI KELUAR (Dashboard)
            dashboardView.classList.remove(...animVisible);
            dashboardView.classList.add(...animHidden);
            
            if(floatBtn) {
                floatBtn.classList.remove(...btnVisible);
                floatBtn.classList.add(...btnHidden);
            }
            
            setTimeout(() => {
                dashboardView.classList.add('hidden');
                reportsView.classList.remove('hidden');
                if(floatBtn) floatBtn.classList.add('hidden');

                void reportsView.offsetWidth;
                reportsView.classList.remove(...animHidden);
                reportsView.classList.add(...animVisible);
                
                renderReportCharts();
            }, 300);
        }
    }

    // ==========================================
    // 2. FUNGSI RENDER CHART (ANTI-CRASH)
    // ==========================================
    
// --- VARIABEL GLOBAL CHART ---
    let reportChartInstances = {};

    function renderReportCharts() {
        // 1. CEK DATA
        if (!allData || allData.length === 0) return;

        // --- 2. PERSIAPAN DATA (Sama seperti sebelumnya) ---
        let materialStats = {};
        let trendDataMap = {}; 
        let kerusakanMap = { "Rusak Ringan": 0, "Rusak Sedang": 0, "Rusak Berat": 0 };
        let konstruksiMap = {}; 

        allData.forEach(d => {
            // A. Hitung Material
            if(d.bantuan && typeof d.bantuan === 'object') {
                for (const [mat, jumlah] of Object.entries(d.bantuan)) {
                    const val = parseFloat(jumlah);
                    if(val > 0) materialStats[mat] = (materialStats[mat] || 0) + val;
                }
            }
            // B. Hitung Tren
            if(d.dateObj && d.dateObj instanceof Date && !isNaN(d.dateObj)) {
                const sortKey = d.dateObj.toISOString().slice(0, 7);
                const labelName = d.dateObj.toLocaleDateString('id-ID', { month: 'short', year: 'numeric' });
                if(!trendDataMap[sortKey]) trendDataMap[sortKey] = { label: labelName, count: 0 };
                trendDataMap[sortKey].count++;
            }
            // C. Hitung Kerusakan & Konstruksi
            let level = d.kerusakan || "Tanpa Kategori";
            if (level.toLowerCase().includes("ringan")) level = "Rusak Ringan";
            else if (level.toLowerCase().includes("sedang")) level = "Rusak Sedang";
            else if (level.toLowerCase().includes("berat")) level = "Rusak Berat";
            kerusakanMap[level] = (kerusakanMap[level] || 0) + 1;

            let kons = d.konstruksi || "Lainnya";
            if (!konstruksiMap[kons]) konstruksiMap[kons] = { "Rusak Ringan": 0, "Rusak Sedang": 0, "Rusak Berat": 0, "Lainnya": 0 };
            if (["Rusak Ringan", "Rusak Sedang", "Rusak Berat"].includes(level)) konstruksiMap[kons][level]++;
            else konstruksiMap[kons]["Lainnya"]++;
        });

        // --- 3. RENDER TABEL MATERIAL (Sama seperti sebelumnya) ---
        const thead = document.getElementById('material-table-head');
        const tbody = document.getElementById('material-table-body');
        
        if(thead && tbody) {
            // Cek apakah tabel perlu di-render ulang sepenuhnya (untuk performa)
            // Kita render ulang tabel hanya untuk memastikan urutan data benar
            thead.innerHTML = '';
            tbody.innerHTML = '';

            const sortedMat = Object.entries(materialStats).sort((a,b) => b[1] - a[1]);

            if (sortedMat.length === 0) {
                tbody.innerHTML = '<tr><td class="p-4 text-center text-gray-400 italic" colspan="100%">Belum ada data logistik keluar.</td></tr>';
            } else {
                let headerHTML = "<tr>";
                let bodyHTML = "<tr>";

                sortedMat.forEach(([item, count]) => {
                    headerHTML += `<th class="px-6 py-4 border-r border-gray-100 dark:border-gray-700 last:border-none min-w-[120px]">${item}</th>`;
                    bodyHTML += `<td class="px-6 py-4 border-r border-gray-100 dark:border-gray-700 last:border-none"><span class="text-xl font-bold text-primary">${count.toLocaleString('id-ID')}</span></td>`;
                });

                headerHTML += "</tr>";
                bodyHTML += "</tr>";
                thead.innerHTML = headerHTML;
                tbody.innerHTML = bodyHTML;
            }
        }

        // --- 4. FUNGSI HELPER CHART (REVISI ANTI-FLICKER) ---
        const createChart = (id, type, data, options) => {
            const canvas = document.getElementById(id);
            if (!canvas) return; 
            
            // CEK: Apakah chart sudah ada?
            if (reportChartInstances[id]) {
                // JIKA ADA: Cukup UPDATE datanya saja (Jangan dihancurkan!)
                reportChartInstances[id].data = data;
                reportChartInstances[id].options = options;
                reportChartInstances[id].update('none'); // 'none' = Update instan tanpa animasi ulang
            } else {
                // JIKA BELUM: Baru buat chart baru
                const ctx = canvas.getContext('2d');
                reportChartInstances[id] = new Chart(ctx, { type, data, options });
            }
        };

        const isDark = document.documentElement.classList.contains('dark');
        const textColor = isDark ? '#EAEAEA' : '#333';
        const gridColor = isDark ? '#404040' : '#E5E7EB';

        // --- 5. EKSEKUSI CHART ---
        
        // A. Chart Tren
        const sortedKeys = Object.keys(trendDataMap).sort();
        createChart('chartTrenBulanan', 'line', {
            labels: sortedKeys.map(k => trendDataMap[k].label),
            datasets: [{
                label: 'Jumlah Kejadian',
                data: sortedKeys.map(k => trendDataMap[k].count),
                borderColor: '#3B82F6', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 2, tension: 0.4, fill: true
            }]
        }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { display: false }, ticks: { color: textColor } } } });

        // B. Chart Kerusakan
	const rusLabels = ["Rusak Ringan", "Rusak Sedang", "Rusak Berat"];
        createChart('chartTingkatKerusakan', 'bar', {
            labels: rusLabels,
            datasets: [{
                label: 'Jumlah Lokasi',
                data: rusLabels.map(l => kerusakanMap[l] || 0),
                backgroundColor: [
                    '#4ADE80', // Hijau
                    '#FACC15', // Kuning
                    '#EF4444'  // Merah
                ],
                borderRadius: 0, // Sudut batang agak tumpul biar modern
                barPercentage: 0.6 // Lebar batang
            }]
        }, { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { legend: { display: false } }, // Sembunyikan legend karena label sudah ada di bawah
            scales: {
                y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } },
                x: { grid: { display: false }, ticks: { color: textColor } }
            }
        });

        // C. Chart Konstruksi
        const konsLabels = ['Permanen', 'Semi Permanen', 'Non Permanen'].filter(
             label => Object.keys(konstruksiMap).includes(label)
        );
        createChart('chartKonstruksi', 'bar', {
            labels: konsLabels,
            datasets: [
                { label: 'Rusak Ringan', data: konsLabels.map(k => konstruksiMap[k]["Rusak Ringan"]), backgroundColor: '#4ADE80' },
                { label: 'Rusak Sedang', data: konsLabels.map(k => konstruksiMap[k]["Rusak Sedang"]), backgroundColor: '#FACC15' },
                { label: 'Rusak Berat',  data: konsLabels.map(k => konstruksiMap[k]["Rusak Berat"]),  backgroundColor: '#EF4444' }
            ]
        }, { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, grid: { display: false }, ticks: { color: textColor } }, y: { stacked: true, grid: { color: gridColor }, ticks: { color: textColor }, beginAtZero: true } }, plugins: { legend: { position: 'top', align: 'end', labels: { color: textColor } } } });
    }
   
    </script>

<div id="image-preview-modal" onclick="closeImagePreview()" 
         class="hidden fixed inset-0 z-[10000] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
        
        <button class="absolute top-6 right-6 text-white/70 hover:text-white transition-colors">
            <span class="material-symbols-outlined text-4xl">close</span>
        </button>

        <img id="preview-image-element" src="" 
             class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl scale-95 transition-transform duration-300"
             onclick="event.stopPropagation()"> </div>

</body>
</html>
