<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Peta Bencana</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Dasar Halaman */
        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif; overflow: hidden;
            background-color: #f0f2f5;
        }
        /* Header Halaman */
        #header {
            position: absolute; top: 0; left: 0; right: 0;
            height: 50px; background-color: #ffffff;
            z-index: 1001; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex; align-items: center; padding: 0 20px;
            font-size: 1.1em; font-weight: 500; color: #1f1f1f;
        }
        #header img { height: 30px; margin-right: 15px; }
        /* Kontainer Peta */
        #map {
            position: absolute; top: 50px; left: 0; right: 0; bottom: 0;
        }
        /* Sidebar Detail */
        #sidebar {
            position: absolute; left: -400px; top: 65px; bottom: 15px;
            width: 360px; background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-radius: 8px;
            transition: left 0.5s ease; z-index: 2000;
            display: flex; flex-direction: column;
        }
        #sidebar.visible { left: 15px; }
        #sidebar-header { padding: 15px 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        #sidebar-header h3 { margin: 0; font-size: 1.1em; }
        #sidebar-content { padding: 0 20px 20px; overflow-y: auto; }
        .close-btn { font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .close-btn:hover { color: #333; }
        /* Kotak Statistik */
        #summary-box {
            position: absolute; top: 65px; right: 15px;
            width: 220px; background: white;
            padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 999;
        }
        #summary-box h4 { margin: 0 0 10px; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .stat-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; }
        .stat-item span:first-child { font-weight: 500; }
        .stat-item span:last-child { font-weight: 700; background-color: #f0f2f5; padding: 2px 6px; border-radius: 4px; }
        /* Kontrol Filter */
        #filter-control {
            position: absolute; bottom: 15px; left: 50%;
            transform: translateX(-50%);
            background: white; padding: 10px 15px;
            border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 999; display: flex; gap: 20px;
        }
        .filter-option { display: flex; align-items: center; }
        .filter-option input { margin-right: 8px; }
        /* Indikator Loading */
        #loader {
            position: absolute; top: 50%; left: 50%;
            border: 8px solid #f3f3f3; border-top: 8px solid #3498db;
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1s linear infinite; z-index: 2000;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="header">
    <img src="https://bidangrrjember.github.io/peta-bencana-jember/logo-bpbd.png" alt="Logo">
    <span>Dashboard Pemetaan Bencana - BPBD Kab. Jember</span>
</div>
<div id="loader"></div>
<div id="map"></div>
<div id="sidebar">
    <div id="sidebar-header">
        <h3 id="sidebar-title">Detail Laporan</h3>
        <span class="close-btn" onclick="closeSidebar()">&times;</span>
    </div>
    <div id="sidebar-content"></div>
</div>
<div id="summary-box">
    <h4>Ringkasan Laporan</h4>
    <div class="stat-item"><span>Rusak Berat:</span> <span id="stat-berat">0</span></div>
    <div class="stat-item"><span>Rusak Sedang:</span> <span id="stat-sedang">0</span></div>
    <div class="stat-item"><span>Rusak Ringan:</span> <span id="stat-ringan">0</span></div>
    <hr>
    <div class="stat-item"><span>TOTAL:</span> <span id="stat-total">0</span></div>
</div>
<div id="filter-control">
    <label class="filter-option"><input type="checkbox" id="filter-berat" checked> Rusak Berat</label>
    <label class="filter-option"><input type="checkbox" id="filter-sedang" checked> Rusak Sedang</label>
    <label class="filter-option"><input type="checkbox" id="filter-ringan" checked> Rusak Ringan</label>
</div>

<script>
    const DATA_URL = 'https://script.google.com/macros/s/AKfycby1d20U2KKj_Vdno5E1pqhQ3P0KqSHF3El1N75qEbWGuupgzQvtTdMVNp6_uIqFpIMU/exec';
    const mapCenter = [-8.17, 113.70];
    const initialZoom = 12;
    const loader = document.getElementById('loader');

    // Definisi Pilihan Peta
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' });
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri' });
    const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' });
    const terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenTopoMap' });
    
    // Inisialisasi Peta
    const map = L.map('map', { center: mapCenter, zoom: initialZoom, layers: [osm] });
    
    // Membuat layer group untuk filter
    const rusakBeratLayer = L.layerGroup().addTo(map);
    const rusakSedangLayer = L.layerGroup().addTo(map);
    const rusakRinganLayer = L.layerGroup().addTo(map);

    // Menambahkan Kontrol Pilihan Peta (Basemap)
    const baseMaps = { "Peta Jalan": osm, "Citra Satelit": satellite, "Mode Gelap": dark, "Topografi": terrain };
    // Menambahkan Kontrol Overlay untuk filter
    const overlayMaps = {
        "Rusak Berat": rusakBeratLayer,
        "Rusak Sedang": rusakSedangLayer,
        "Rusak Ringan": rusakRinganLayer
    };
    // --- PERUBAHAN DI SINI ---
    L.control.layers(baseMaps, overlayMaps, { position: 'bottomright' }).addTo(map);

    // Definisi ikon marker
    const iconRusakBerat = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41], iconAnchor: [12, 41] });
    const iconRusakSedang = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png', iconSize: [25, 41], iconAnchor: [12, 41] });
    const iconRusakRingan = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize: [25, 41], iconAnchor: [12, 41] });

    // Mengambil data dan memprosesnya
    fetch(DATA_URL)
        .then(response => response.json())
        .then(data => {
            loader.style.display = 'none';
            let countBerat = 0, countSedang = 0, countRingan = 0;

            data.forEach(item => {
                let marker;
                if (item.kerusakan === 'Rusak Berat') {
                    marker = L.marker([item.lat, item.lng], {icon: iconRusakBerat}).addTo(rusakBeratLayer);
                    countBerat++;
                } else if (item.kerusakan === 'Rusak Sedang') {
                    marker = L.marker([item.lat, item.lng], {icon: iconRusakSedang}).addTo(rusakSedangLayer);
                    countSedang++;
                } else {
                    marker = L.marker([item.lat, item.lng], {icon: iconRusakRingan}).addTo(rusakRinganLayer);
                    countRingan++;
                }
                marker.on('click', () => openSidebarWithData(item));
            });

            document.getElementById('stat-berat').innerText = countBerat;
            document.getElementById('stat-sedang').innerText = countSedang;
            document.getElementById('stat-ringan').innerText = countRingan;
            document.getElementById('stat-total').innerText = data.length;
        })
        .catch(error => {
            console.error('Gagal mengambil data:', error);
            loader.style.display = 'none';
            alert("Tidak dapat memuat data lokasi.");
        });
    
    // Mengatur fungsi filter
    document.getElementById('filter-berat').addEventListener('change', (e) => {
        e.target.checked ? map.addLayer(rusakBeratLayer) : map.removeLayer(rusakBeratLayer);
    });
    document.getElementById('filter-sedang').addEventListener('change', (e) => {
        e.target.checked ? map.addLayer(rusakSedangLayer) : map.removeLayer(rusakSedangLayer);
    });
    document.getElementById('filter-ringan').addEventListener('change', (e) => {
        e.target.checked ? map.addLayer(rusakRinganLayer) : map.removeLayer(rusakRinganLayer);
    });
    
    // Fungsi untuk sidebar
    function openSidebarWithData(data) {
        const sidebar = document.getElementById('sidebar');
        const content = document.getElementById('sidebar-content');
        const sidebarTitle = document.getElementById('sidebar-header').querySelector('h3');

        sidebarTitle.innerText = data.nama || 'Detail Laporan';
        content.innerHTML = `<h4>Detail Lokasi</h4><p><strong>Jalan/Dusun:</strong><br>${data.dusun||'Tidak ada data'}</p><p><strong>Kelurahan/Desa:</strong><br>${data.kelurahan||'Tidak ada data'}</p><p><strong>Kecamatan:</strong><br>${data.kecamatan||'Tidak ada data'}</p><h4>Detail Bencana & Asesmen</h4><p><strong>Jenis Bencana:</strong><br>${data.bencana||'Tidak ada data'}</p><p><strong>Waktu Asesmen:</strong><br>${data.hari||''}, ${data.tanggalWaktu||''}</p><p><strong>Pengkajian:</strong><br>${data.pengkajian||'Tidak ada data'}</p><h4>Detail Kerusakan & Kerugian</h4><p><strong>Tingkat Kerusakan:</strong><br>${data.kerusakan||'Tidak ada data'}</p><p><strong>Bagian Rusak:</strong><br>${data.bagianRusak||'Tidak ada data'}</p><p><strong>Taksiran Kerusakan:</strong><br>${data.nilaiKerusakan||'Tidak ada data'}</p><p><strong>Taksiran Kerugian:</strong><br>${data.nilaiKerugian||'Tidak ada data'}</p>`;
        sidebar.classList.add('visible');
    }
    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('visible');
    }
</script>

</body>
</html>